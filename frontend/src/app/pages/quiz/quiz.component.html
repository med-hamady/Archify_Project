<div class="quiz-container">
  <!-- Top Progress Bar -->
  <div *ngIf="currentQuestion" class="top-progress-bar">
    <div
      class="top-progress-fill"
      [style.width.%]="(((currentQuestion.position || currentQuestion.orderIndex || 0) + 1) / (currentQuestion.totalQuestions || 1)) * 100">
    </div>
  </div>

  <!-- Header -->
  <div class="quiz-header">
    <button (click)="goBack()" class="back-btn">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
      Retour
    </button>
    <div *ngIf="currentQuestion" class="header-center">
      <span class="chapter-title">{{ currentQuestion.chapterTitle }}</span>
    </div>
    <div *ngIf="currentQuestion" class="progress-info">
      <span class="question-counter">
        Question {{ (currentQuestion.position || currentQuestion.orderIndex || 0) + 1 }} / {{ currentQuestion.totalQuestions || 0 }}
      </span>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Chargement de la question...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error && !loading" class="error-message">
    <p>{{ error }}</p>
    <button (click)="goBack()" class="btn btn-secondary">
      Retour au Dashboard
    </button>
  </div>

  <!-- Chapter Completed -->
  <div *ngIf="chapterCompleted && !loading" class="completion-card">
    <div class="completion-icon">ğŸ‰</div>
    <h2>Chapitre terminÃ©!</h2>
    <p class="completion-message">{{ completionMessage }}</p>
    <div class="completion-actions">
      <button (click)="replayChapter()" class="btn btn-primary btn-large">
        ğŸ”„ Rejouer le chapitre
      </button>
      <button (click)="goBack()" class="btn btn-secondary btn-large">
        â† Retour au Dashboard
      </button>
    </div>
    <p class="replay-note">ğŸ’¡ En mode rejeu, vous ne gagnerez pas d'XP supplÃ©mentaire</p>
  </div>

  <!-- Question Card -->
  <div *ngIf="currentQuestion && !loading" class="question-card">
    <!-- Replay Mode Badge -->
    <div *ngIf="currentQuestion.isReplay" class="replay-badge">
      ğŸ”„ Mode RÃ©vision - Pas d'XP
    </div>

    <!-- Question Text -->
    <div class="question-text">
      <h2>{{ currentQuestion.questionText }}</h2>
    </div>

    <!-- Question Image (si prÃ©sente) -->
    <div *ngIf="getQuestionImageUrl()" class="question-image">
      <img [src]="getQuestionImageUrl()" [alt]="currentQuestion.questionText" />
    </div>

    <!-- Answer Options -->
    <div class="answer-options">
      <button
        *ngFor="let option of currentQuestion.options; let i = index"
        class="answer-option"
        [class.selected]="isSelected(i)"
        [class.correct]="showResult && result?.options?.[i]?.isCorrect && !result?.options?.[i]?.isPartial"
        [class.incorrect]="showResult && result?.options?.[i]?.wasSelected && !result?.options?.[i]?.isCorrect && !result?.options?.[i]?.isPartial"
        [class.partial]="showResult && result?.options?.[i]?.isPartial"
        [class.disabled]="answered"
        (click)="selectAnswer(i)">
        <span class="option-letter">
          <span class="letter-text" [class.hidden]="isSelected(i)">{{ ['A', 'B', 'C', 'D', 'E'][i] }}</span>
          <svg *ngIf="isSelected(i)" class="check-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </span>
        <span class="option-text">{{ option.text }}</span>

        <!-- Result Icons -->
        <span *ngIf="showResult && result?.options?.[i]?.isCorrect && !result?.options?.[i]?.isPartial" class="result-icon correct-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </span>
        <span *ngIf="showResult && result?.options?.[i]?.wasSelected && !result?.options?.[i]?.isCorrect && !result?.options?.[i]?.isPartial" class="result-icon incorrect-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </span>
        <span *ngIf="showResult && result?.options?.[i]?.isPartial" class="result-icon partial-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
        </span>

        <!-- Justification pour les rÃ©ponses fausses ou partielles -->
        <div *ngIf="showResult && result?.options?.[i]?.justification" class="justification">
          <span class="justification-text">{{ result?.options?.[i]?.justification }}</span>
        </div>
      </button>
    </div>

    <!-- Submit/Next Button -->
    <div class="action-section">
      <button
        *ngIf="!answered"
        (click)="submitAnswer()"
        class="btn btn-primary btn-large">
        Valider {{ selectedAnswers.length > 0 ? '(' + selectedAnswers.length + ' rÃ©ponse' + (selectedAnswers.length > 1 ? 's' : '') + ')' : '(aucune rÃ©ponse)' }}
      </button>

      <button
        *ngIf="answered"
        (click)="nextQuestion()"
        class="btn btn-primary btn-large">
        Question suivante â†’
      </button>
    </div>

    <!-- Result Panel -->
    <div *ngIf="showResult && result" class="result-panel" [class.correct-result]="result.correct" [class.incorrect-result]="!result.correct">
      <div class="result-header">
        <img [src]="result.correct ? '/vraie-reponse.png' : '/faux-reponse.png'" [alt]="result.correct ? 'Bonne rÃ©ponse' : 'Mauvaise rÃ©ponse'" class="result-icon-img"/>
        <h3>{{ result.correct ? 'Bonne rÃ©ponse !' : 'Mauvaise rÃ©ponse' }}</h3>
      </div>

      <!-- XP Earned -->
      <div class="xp-earned">
        <span class="xp-label">XP gagnÃ©</span>
        <span class="xp-value">+{{ result.xpEarned }} XP</span>
      </div>

      <!-- Total XP -->
      <div class="total-xp">
        Total: {{ result.totalXP }} XP
      </div>

      <!-- Level Progress -->
      <div class="level-progress">
        <div class="level-info-mini">
          <span>Niveau {{ result.levelInfo.current }} - {{ result.levelInfo.name }}</span>
          <span class="level-bar">
            <span
              class="level-fill"
              [style.width.%]="result.levelInfo.progress">
            </span>
          </span>
        </div>
        <div class="xp-to-next">
          {{ result.levelInfo.xpToNext }} XP jusqu'au prochain niveau
        </div>
      </div>

      <!-- Explanation -->
      <div *ngIf="result.explanation" class="explanation">
        <h4>ğŸ’¡ Explication</h4>
        <p>{{ result.explanation }}</p>
      </div>

      <!-- Bonuses -->
      <div *ngIf="result.consecutiveBonus" class="bonus-alert">
        ğŸ”¥ {{ result.consecutiveBonus.message }} ! +{{ result.consecutiveBonus.xpBonus }} XP bonus !
      </div>
    </div>
  </div>

  <!-- Animations -->
  <div *ngIf="showXPAnimation" class="xp-animation">
    <div class="xp-popup">
      +{{ result?.xpEarned }} XP
    </div>
  </div>

  <div *ngIf="showLevelUpAnimation" class="levelup-animation">
    <div class="levelup-popup">
      <h2>ğŸŠ LEVEL UP! ğŸŠ</h2>
      <p>Nouveau niveau: {{ result?.levelUp?.newLevel }}</p>
    </div>
  </div>

  <div *ngIf="showBadgeAnimation && result?.newBadges" class="badge-animation">
    <div class="badge-popup">
      <h2>ğŸ† Nouveau Badge! ğŸ†</h2>
      <div *ngFor="let badge of result?.newBadges" class="badge-item">
        <h3>{{ badge.name }}</h3>
        <p>{{ badge.description }}</p>
      </div>
    </div>
  </div>
</div>
