<div class="exam-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>{{ currentState === 'playing' ? 'Soumission en cours...' : currentState === 'correction' ? 'Chargement de la correction...' : 'Chargement de l\'examen...' }}</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-message">
    <div class="error-icon">‚ö†Ô∏è</div>
    <p>{{ error }}</p>
    <div class="error-actions">
      <button class="btn btn-secondary" (click)="backToDashboard()">Retour au tableau de bord</button>
      <button class="btn btn-primary" (click)="loadExam()">R√©essayer</button>
    </div>
  </div>

  <!-- Start Screen -->
  <div *ngIf="!loading && !error && currentState === 'start' && exam" class="start-screen">
    <div class="start-card">
      <div class="exam-icon"><img src="/mode-examen.png" alt="Mode Examen" class="exam-icon-img"/></div>
      <h1>Mode Examen</h1>
      <h2>{{ exam.subjectName }}</h2>

      <div class="exam-info">
        <div class="info-item">
          <span class="info-icon">‚ùì</span>
          <span class="info-text">{{ exam.totalQuestions }} questions</span>
        </div>
        <div class="info-item">
          <span class="info-icon">‚ö°</span>
          <span class="info-text">√ó2 XP Bonus</span>
        </div>
        <div class="info-item">
          <span class="info-icon">üéØ</span>
          <span class="info-text">Note /20</span>
        </div>
        <div class="info-item">
          <span class="info-icon">‚è±Ô∏è</span>
          <span class="info-text">24h de cooldown</span>
        </div>
      </div>

      <div class="requirements">
        <h3>üîì Conditions d√©bloqu√©es</h3>
        <ul>
          <li>‚úÖ Progression ‚â• 50% dans la mati√®re</li>
          <li>‚úÖ Questions d√©j√† vues en mode R√©vision</li>
        </ul>
      </div>

      <div class="rules">
        <h3>üìã R√®gles</h3>
        <ul>
          <li>Questions s√©lectionn√©es parmi celles d√©j√† vues</li>
          <li>Navigation libre entre les questions</li>
          <li>Note calcul√©e sur 20</li>
          <li>R√©ussite ‚â• 10/20</li>
          <li>Correction d√©taill√©e par chapitre</li>
        </ul>
      </div>

      <!-- Question Count Selection -->
      <div class="exam-option-selection">
        <h3>üìù Nombre de questions</h3>
        <p class="option-description">Choisissez combien de questions vous voulez</p>
        <div class="option-buttons">
          <button
            *ngFor="let count of questionCountOptions"
            class="option-btn"
            [class.selected]="selectedQuestionCount === count"
            (click)="selectedQuestionCount = count; loadExam()">
            {{ count }} questions
          </button>
        </div>
      </div>

      <!-- Duration Selection -->
      <div class="exam-option-selection">
        <h3>‚è±Ô∏è Dur√©e de l'examen</h3>
        <p class="option-description">Choisissez votre limite de temps</p>
        <div class="option-buttons">
          <button
            *ngFor="let duration of durationOptions"
            class="option-btn"
            [class.selected]="selectedDuration === duration"
            (click)="selectedDuration = duration; loadExam()">
            {{ duration }} min
          </button>
        </div>
      </div>

      <button class="btn btn-start" (click)="startPlaying()">
        Commencer l'Examen ({{ exam.totalQuestions }} questions, {{ exam.duration || selectedDuration }} min)
        <span class="arrow">‚Üí</span>
      </button>
      <button class="btn btn-secondary" (click)="backToDashboard()">Annuler</button>
    </div>
  </div>

  <!-- Playing Screen -->
  <div *ngIf="!loading && !error && currentState === 'playing' && exam" class="playing-screen">

    <!-- Header -->
    <div class="playing-header">
      <div class="progress-info">
        <span class="question-counter">Question {{ currentQuestionIndex + 1 }} / {{ exam.totalQuestions }}</span>
        <span class="answered-counter">R√©pondu: {{ getAnsweredCount() }} / {{ exam.totalQuestions }}</span>
        <span class="timer" [class.timer-warning]="timerWarning">
          ‚è±Ô∏è {{ getTimerDisplay() }}
        </span>
      </div>
      <div class="mini-progress">
        <div class="mini-progress-fill" [style.width.%]="(getAnsweredCount() / exam.totalQuestions * 100)"></div>
      </div>
      <div class="chapter-indicator" *ngIf="getCurrentQuestion()">
        üìñ {{ getCurrentQuestion()!.chapterTitle }}
      </div>
    </div>

    <!-- Question Card -->
    <div class="question-card" *ngIf="getCurrentQuestion()">
      <div class="question-header">
        <span class="question-number">#{{ currentQuestionIndex + 1 }}</span>
      </div>

      <div class="question-text">
        {{ getCurrentQuestion()!.questionText }}
      </div>

      <div class="options">
        <div
          *ngFor="let option of getCurrentQuestion()!.options; let i = index"
          class="option"
          [class.selected]="isAnswerSelected(i)"
          (click)="toggleAnswer(i)">
          <div class="option-checkbox">
            <input
              type="checkbox"
              [checked]="isAnswerSelected(i)"
              (click)="$event.preventDefault()"
              readonly>
            <span class="option-letter">{{ ['A', 'B', 'C', 'D', 'E'][i] }}</span>
          </div>
          <div class="option-text">{{ option }}</div>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="navigation">
      <button
        class="btn btn-secondary"
        [disabled]="currentQuestionIndex === 0"
        (click)="previousQuestion()">
        ‚Üê Pr√©c√©dent
      </button>

      <div class="question-dots">
        <div
          *ngFor="let q of exam.questions; let i = index"
          class="question-dot"
          [class.current]="i === currentQuestionIndex"
          [class.answered]="answers[i].selectedAnswers.length > 0"
          (click)="goToQuestion(i)">
          {{ i + 1 }}
        </div>
      </div>

      <button
        class="btn btn-secondary"
        *ngIf="currentQuestionIndex < exam.totalQuestions - 1"
        (click)="nextQuestion()">
        Suivant ‚Üí
      </button>

      <button
        class="btn btn-primary btn-submit"
        *ngIf="currentQuestionIndex === exam.totalQuestions - 1"
        [disabled]="!canSubmit()"
        (click)="submitExam()">
        Soumettre üìù
      </button>
    </div>
  </div>

  <!-- Results Screen -->
  <div *ngIf="!loading && !error && currentState === 'results' && result" class="results-screen">
    <div class="results-card">

      <!-- Result Header -->
      <div class="result-header">
        <div class="result-icon" [class.passed]="result.passed">
          {{ result.passed ? 'üéâ' : 'üìä' }}
        </div>
        <h1>{{ result.passed ? 'Examen R√©ussi!' : 'Examen Termin√©' }}</h1>

        <div class="grade-display" [class]="getGradeClass(result.grade)">
          <span class="grade">{{ result.grade }}</span>
        </div>

        <div class="score-display">
          <span class="score">{{ result.scoreOutOf20.toFixed(2) }}</span>
          <span class="separator">/</span>
          <span class="total">20</span>
        </div>

        <div class="raw-score">
          {{ result.score }} / {{ result.totalQuestions }} r√©ponses correctes
        </div>
      </div>

      <!-- Pass/Fail Alert -->
      <div class="alert" [class.alert-success]="result.passed" [class.alert-danger]="!result.passed">
        <span class="alert-icon">{{ result.passed ? '‚úÖ' : '‚ùå' }}</span>
        <span class="alert-text">
          {{ result.passed ? 'F√©licitations! Vous avez r√©ussi l\'examen.' : 'Vous devez obtenir au moins 10/20 pour r√©ussir.' }}
        </span>
      </div>

      <!-- XP Earned -->
      <div class="xp-earned-section">
        <div class="xp-item">
          <span class="xp-label">XP Gagn√©</span>
          <span class="xp-value">+{{ result.xpEarned }} XP</span>
        </div>
        <div class="xp-item multiplier">
          <span class="xp-label">Multiplicateur</span>
          <span class="xp-value">√ó2</span>
        </div>
        <div class="xp-item total">
          <span class="xp-label">XP Total</span>
          <span class="xp-value">{{ result.totalXP }} XP</span>
        </div>
      </div>

      <!-- Level Up Alert -->
      <div class="alert alert-levelup" *ngIf="result.levelUp">
        <span class="alert-icon">üéâ</span>
        <span class="alert-text">
          Niveau augment√©: {{ result.levelUp.oldLevel }} ‚Üí {{ result.levelUp.newLevel }}!
        </span>
      </div>

      <!-- New Badges Alert -->
      <div class="alert alert-badge" *ngIf="result.newBadges && result.newBadges.length > 0">
        <span class="alert-icon">üèÖ</span>
        <span class="alert-text">
          {{ result.newBadges.length }} nouveau{{ result.newBadges.length > 1 ? 'x' : '' }} badge{{ result.newBadges.length > 1 ? 's' : '' }}!
        </span>
      </div>

      <!-- Actions -->
      <div class="result-actions">
        <button class="btn btn-secondary" (click)="backToDashboard()">Retour au tableau de bord</button>
        <button class="btn btn-primary" (click)="viewCorrection()">Voir la correction üìñ</button>
      </div>
    </div>
  </div>

  <!-- Correction Screen -->
  <div *ngIf="!loading && !error && currentState === 'correction' && correction" class="correction-screen">
    <div class="correction-card">

      <!-- Correction Header -->
      <div class="correction-header">
        <h1>üìñ Correction D√©taill√©e</h1>
        <div class="correction-summary">
          <div class="summary-item">
            <span class="summary-label">Note</span>
            <span class="summary-value grade" [class]="getGradeClass(correction.grade)">
              {{ correction.scoreOutOf20.toFixed(2) }}/20 ({{ correction.grade }})
            </span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Score</span>
            <span class="summary-value">{{ correction.score }}/{{ correction.totalQuestions }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">R√©sultat</span>
            <span class="summary-value" [class.passed]="correction.passed" [class.failed]="!correction.passed">
              {{ correction.passed ? 'R√©ussi ‚úÖ' : '√âchou√© ‚ùå' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Chapter Tabs -->
      <div class="chapter-tabs">
        <button
          *ngFor="let chapter of correction.chapterBreakdown; let i = index"
          class="chapter-tab"
          [class.active]="selectedChapterIndex === i"
          (click)="selectChapter(i)">
          <div class="tab-title">{{ chapter.chapterTitle }}</div>
          <div class="tab-score">{{ chapter.score }}/{{ chapter.totalQuestions }}</div>
        </button>
      </div>

      <!-- Chapter Questions -->
      <div class="chapter-questions" *ngIf="getSelectedChapter()">
        <h2>{{ getSelectedChapter()!.chapterTitle }}</h2>
        <div class="chapter-score-info">
          Score: {{ getSelectedChapter()!.score }} / {{ getSelectedChapter()!.totalQuestions }}
          ({{ (getSelectedChapter()!.score / getSelectedChapter()!.totalQuestions * 100).toFixed(0) }}%)
        </div>

        <div class="questions-list">
          <div
            *ngFor="let question of getSelectedChapter()!.questions; let i = index"
            class="correction-item"
            [class.correct]="question.isCorrect"
            [class.incorrect]="!question.isCorrect">

            <div class="correction-item-header">
              <span class="correction-number">#{{ i + 1 }}</span>
              <span class="correction-status">
                {{ question.isCorrect ? '‚úÖ Correct' : '‚ùå Incorrect' }}
              </span>
            </div>

            <div class="correction-question">{{ question.questionText }}</div>

            <div class="correction-answers">
              <!-- R√©ponse incorrecte de l'utilisateur -->
              <div class="answer-row user-answer" *ngIf="!question.isCorrect">
                <span class="answer-label">Votre r√©ponse:</span>
                <span class="answer-text incorrect">
                  <!-- Choix unique -->
                  <ng-container *ngIf="question.userAnswer !== null && question.userAnswer !== undefined">
                    {{ ['A', 'B', 'C', 'D', 'E'][question.userAnswer] }} - {{ question.options[question.userAnswer] }}
                  </ng-container>
                  <!-- Choix multiples -->
                  <ng-container *ngIf="question.userAnswers && question.userAnswers.length > 0">
                    <span *ngFor="let idx of question.userAnswers; let i = index">
                      {{ ['A', 'B', 'C', 'D', 'E'][idx] }} - {{ question.options[idx] }}<span *ngIf="i < question.userAnswers.length - 1"> ; </span>
                    </span>
                  </ng-container>
                  <!-- Aucune r√©ponse -->
                  <ng-container *ngIf="(!question.userAnswer && question.userAnswer !== 0) && (!question.userAnswers || question.userAnswers.length === 0)">
                    Aucune r√©ponse
                  </ng-container>
                </span>
              </div>

              <!-- Bonne r√©ponse -->
              <div class="answer-row correct-answer">
                <span class="answer-label">{{ question.isCorrect ? 'Votre r√©ponse:' : 'Bonne r√©ponse:' }}</span>
                <span class="answer-text correct">
                  <!-- Choix unique -->
                  <ng-container *ngIf="question.correctAnswer !== null && question.correctAnswer !== undefined">
                    {{ ['A', 'B', 'C', 'D', 'E'][question.correctAnswer] }} - {{ question.options[question.correctAnswer] }}
                  </ng-container>
                  <!-- Choix multiples -->
                  <ng-container *ngIf="question.correctAnswers && question.correctAnswers.length > 0">
                    <span *ngFor="let idx of question.correctAnswers; let i = index">
                      {{ ['A', 'B', 'C', 'D', 'E'][idx] }} - {{ question.options[idx] }}<span *ngIf="i < question.correctAnswers.length - 1"> ; </span>
                    </span>
                  </ng-container>
                </span>
              </div>
            </div>

            <div class="correction-explanation" *ngIf="question.explanation">
              <span class="explanation-label">üí° Explication:</span>
              <p>{{ question.explanation }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="correction-actions">
        <button class="btn btn-secondary" (click)="backToDashboard()">Retour au tableau de bord</button>
        <button class="btn btn-primary" (click)="restartExam()">Repasser l'examen</button>
      </div>
    </div>
  </div>

  <!-- XP Animation Overlay -->
  <div *ngIf="showXPAnimation" class="xp-animation">
    <div class="xp-popup">+{{ result?.xpEarned }} XP</div>
  </div>

  <!-- Level Up Animation Overlay -->
  <div *ngIf="showLevelUpAnimation && result?.levelUp" class="levelup-overlay">
    <div class="levelup-modal">
      <div class="levelup-icon">üéâ</div>
      <h2>Niveau augment√©!</h2>
      <div class="level-change">
        <span class="old-level">{{ result?.levelUp?.oldLevel }}</span>
        <span class="arrow">‚Üí</span>
        <span class="new-level">{{ result?.levelUp?.newLevel }}</span>
      </div>
    </div>
  </div>

  <!-- Badge Animation Overlay -->
  <div *ngIf="showBadgeAnimation && result?.newBadges" class="badge-overlay">
    <div class="badge-modal">
      <div class="badge-icon">üèÖ</div>
      <h2>Nouveau{{ (result?.newBadges?.length || 0) > 1 ? 'x' : '' }} Badge{{ (result?.newBadges?.length || 0) > 1 ? 's' : '' }}!</h2>
      <div class="badges-list">
        <div *ngFor="let badge of result?.newBadges" class="badge-item">
          <div class="badge-emoji">{{ badge.iconUrl || 'üèÜ' }}</div>
          <div class="badge-name">{{ badge.name }}</div>
          <div class="badge-desc">{{ badge.description }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Level Up Notification -->
  <app-level-up-notification
    [show]="showLevelUpNotification"
    [newLevel]="levelUpNewLevel"
    [userName]="userName">
  </app-level-up-notification>

</div>
