<div class="dashboard-container">
  <!-- Header -->
  <header class="dashboard-header">
    <h1>
      <img src="/design/logo.png" alt="FacGame Logo" class="header-logo">
      FacGame Dashboard
    </h1>
    <p class="subtitle">Plateforme d'apprentissage m√©dical gamifi√©e</p>
  </header>

  <!-- Loading - Skeleton -->
  <div *ngIf="loading" class="skeleton-container">
    <!-- Skeleton User Card -->
    <section class="skeleton-stats-section">
      <div class="skeleton-user-card">
        <div class="skeleton-user-header">
          <div class="skeleton-avatar"></div>
          <div class="skeleton-user-info">
            <div class="skeleton-text skeleton-name"></div>
            <div class="skeleton-text skeleton-semester"></div>
          </div>
        </div>
        <div class="skeleton-level-badge"></div>
        <div class="skeleton-xp-section">
          <div class="skeleton-text skeleton-xp-header"></div>
          <div class="skeleton-progress-bar"></div>
        </div>
        <div class="skeleton-quick-stats">
          <div class="skeleton-stat-item"></div>
          <div class="skeleton-stat-item"></div>
        </div>
        <div class="skeleton-action-buttons">
          <div class="skeleton-btn"></div>
          <div class="skeleton-btn"></div>
        </div>
      </div>
    </section>

    <!-- Skeleton Subjects -->
    <section class="skeleton-subjects-section">
      <div class="skeleton-text skeleton-section-title"></div>
      <div class="skeleton-subjects-grid">
        <div *ngFor="let i of [1, 2, 3]" class="skeleton-subject-card">
          <div class="skeleton-subject-header">
            <div class="skeleton-text skeleton-subject-name"></div>
            <div class="skeleton-badge"></div>
          </div>
          <div class="skeleton-subject-stats">
            <div class="skeleton-text skeleton-stat"></div>
            <div class="skeleton-text skeleton-stat"></div>
            <div class="skeleton-text skeleton-stat"></div>
          </div>
          <div class="skeleton-progress-bar"></div>
          <div class="skeleton-btn skeleton-btn-start"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="error-banner">
    {{ error }}
    <button (click)="loadDashboard()" class="retry-btn">R√©essayer</button>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading && profile" class="dashboard-content">

    <!-- User Stats Section -->
    <section class="stats-section">
      <div class="user-card">
        <div class="user-card-grid">
          <!-- Left Column: Avatar, Name, Level Badge -->
          <div class="user-card-left">
            <div class="user-header">
              <div class="avatar" (click)="triggerFileInput()" [class.has-picture]="profile.profilePicture" [style.border-color]="getLevelInfo()?.color">
                <img *ngIf="profile.profilePicture" [src]="profile.profilePicture" alt="Profile Picture" class="profile-picture">
                <span *ngIf="!profile.profilePicture" class="avatar-initial">{{ profile.name.charAt(0).toUpperCase() }}</span>
                <div class="avatar-overlay">
                  <span class="camera-icon">üì∑</span>
                </div>
                <!-- Level mini badge on avatar -->
                <div class="avatar-level-badge" [style.background]="getLevelInfo()?.color">
                  {{ getLevelInfo()?.label?.charAt(0) }}
                </div>
              </div>
              <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" style="display: none;">
              <div class="user-info">
                <h2>{{ profile.name }}</h2>
                <p class="semester">{{ profile.semester }}</p>
              </div>
            </div>

            <!-- Level Badge with Glow Effect -->
            <div class="level-badge-container">
              <div class="level-badge-glow" [style.--glow-color]="getLevelInfo()?.color"></div>
              <img [src]="getLevelInfo()?.image" [alt]="getLevelInfo()?.label" class="level-badge-image">
              <span class="level-badge-label" [style.background]="getLevelInfo()?.color">{{ getLevelInfo()?.label }}</span>
            </div>
          </div>

          <!-- Right Column: XP, Stats, Buttons -->
          <div class="user-card-right">
            <!-- XP Progress Enhanced -->
            <div class="xp-section">
              <div class="xp-header">
                <div class="xp-level-info">
                  <span class="current-level-badge" [style.background]="getLevelInfo()?.color">{{ getLevelInfo()?.label }}</span>
                  <span class="xp-arrow">‚Üí</span>
                  <span class="next-level-text" *ngIf="getLevelInfo()?.nextLevel !== 'MAX'">{{ getLevelInfo()?.nextLevel }}</span>
                  <span class="next-level-text max" *ngIf="getLevelInfo()?.nextLevel === 'MAX'">MAX</span>
                </div>
                <span class="xp-value">{{ profile.xpTotal }} XP</span>
              </div>
              <div class="progress-bar-enhanced">
                <div
                  class="progress-fill-enhanced"
                  [style.width.%]="getLevelInfo()?.progressPercent"
                  [style.--progress-color]="getLevelInfo()?.color">
                  <div class="progress-shine"></div>
                </div>
              </div>
              <div class="xp-info">
                <span class="xp-current">{{ getLevelInfo()?.xpInLevel }} XP</span>
                <span class="xp-needed">{{ getLevelInfo()?.xpNeeded }} XP</span>
              </div>
            </div>

            <!-- Quick Stats -->
            <div class="quick-stats">
              <div class="stat-item">
                <div class="stat-icon">
                  <img width="32" height="32" src="https://img.icons8.com/ios-filled/50/chain.png" alt="chain" style="filter: brightness(0) saturate(100%) invert(39%) sepia(93%) saturate(1851%) hue-rotate(202deg) brightness(98%) contrast(101%);"/>
                </div>
                <div class="stat-info">
                  <span class="stat-value">{{ profile.consecutiveGoodAnswers }}</span>
                  <span class="stat-label">S√©rie</span>
                </div>
              </div>
              <div class="stat-item">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-info">
                  <span class="stat-value">{{ profile.bestStreak }}</span>
                  <span class="stat-label">Meilleur s√©rie</span>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
              <button (click)="navigateToProfile()" class="btn btn-secondary">
                <img width="24" height="24" src="https://cdn-icons-png.flaticon.com/512/1077/1077012.png" alt="user" style="filter: brightness(0) invert(1);"/> Mon Profil
              </button>
              <button (click)="navigateToLeaderboard()" class="btn btn-primary">
                <img width="24" height="24" src="https://img.icons8.com/ios/50/ratings.png" alt="ratings" style="filter: brightness(0) invert(1);"/> Classement
              </button>
            </div>

            <!-- Logout Button -->
            <div class="logout-section">
              <button (click)="logout()" class="btn btn-logout">
                <img width="24" height="24" src="https://cdn-icons-png.flaticon.com/512/1828/1828490.png" alt="logout" style="filter: brightness(0) invert(1);"/> Se d√©connecter
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Subjects Progress Section -->
    <section class="subjects-section">
      <h2 class="section-title">
        <img width="40" height="40" src="https://img.icons8.com/external-flaticons-lineal-color-flat-icons/64/external-books-literature-flaticons-lineal-color-flat-icons-12.png" alt="books" style="vertical-align: middle; margin-right: 10px;"/>
        Mes Mati√®res
      </h2>

      <div *ngIf="progress.length === 0" class="empty-state">
        <p>Aucune mati√®re disponible pour le moment</p>
      </div>

      <div class="subjects-grid">
        <div
          *ngFor="let subject of progress"
          class="subject-card"
          (click)="navigateToSubject(subject.subjectId)">

          <div class="subject-header">
            <h3>{{ subject.subjectName }}</h3>
            <span class="subject-badge">{{ subject.progressPercent }}%</span>
          </div>

          <div class="subject-stats">
            <div class="stat">
              <img width="20" height="20" src="https://cdn-icons-png.flaticon.com/512/3176/3176390.png" alt="quiz" style="vertical-align: middle;"/>
              <span class="stat-text">
                {{ subject.answeredQCM }} / {{ subject.totalQCM }} questions
              </span>
            </div>
            <div class="stat">
              <img width="20" height="20" src="https://img.icons8.com/external-anggara-outline-color-anggara-putra/32/external-bookmark-file-and-document-anggara-glyph-anggara-putra.png" alt="bookmark" style="vertical-align: middle;"/>
              <span class="stat-text">
                {{ subject.chaptersCompleted }} / {{ subject.chaptersTotal }} chapitres
              </span>
            </div>
            <div class="stat">
              <img width="20" height="20" src="https://cdn-icons-png.flaticon.com/512/337/337946.png" alt="pdf" style="vertical-align: middle;"/>
              <span class="stat-text">{{ subject.pdfCount }} cours PDF</span>
            </div>
            <div class="stat">
              <img width="20" height="20" src="https://cdn-icons-png.flaticon.com/512/1179/1179069.png" alt="video" style="vertical-align: middle;"/>
              <span class="stat-text">{{ subject.videoCount }} vid√©os</span>
            </div>
          </div>

          <div class="progress-bar subject-progress">
            <div
              class="progress-fill"
              [style.width.%]="subject.progressPercent">
            </div>
          </div>

          <!-- Unlock Status -->
          <div class="unlock-status">
            <span
              *ngIf="subject.progressPercent >= 50"
              class="unlock-badge unlock-challenge">
              üéØ Challenge d√©bloqu√©
            </span>
            <span
              *ngIf="subject.progressPercent >= 80"
              class="unlock-badge unlock-exam">
              üìù Examen d√©bloqu√©
            </span>
          </div>

          <button class="btn btn-start">
            <img src="/continuer.png" alt="Continuer" class="btn-continuer-icon"/> Continuer
            <span class="arrow">‚Üí</span>
          </button>
        </div>
      </div>
    </section>
  </div>
</div>
