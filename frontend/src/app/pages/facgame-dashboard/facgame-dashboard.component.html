<div class="dashboard-container">
  <!-- Header -->
  <header class="dashboard-header">
    <h1>
      <img src="design/logo.jpg" alt="FacGame Logo" class="header-logo">
      FacGame Dashboard
    </h1>
    <p class="subtitle">Plateforme d'apprentissage m√©dical gamifi√©e</p>
  </header>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Chargement de votre profil...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="error-banner">
    {{ error }}
    <button (click)="loadDashboard()" class="retry-btn">R√©essayer</button>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading && profile" class="dashboard-content">

    <!-- Diagnostic Appareils -->
    <div *ngIf="devicesInfo" class="diagnostic-card" style="background: #fff3cd; border: 2px solid #ffc107; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
      <h3 style="color: #856404; margin-top: 0;">üîç Diagnostic - Appareils Autoris√©s</h3>
      <div style="font-size: 14px; color: #856404;">
        <p><strong>Email:</strong> {{ devicesInfo.email }}</p>
        <p><strong>Nombre d'appareils autoris√©s:</strong> {{ devicesInfo.authorizedDevicesCount }} / 2</p>
        <p><strong>Appareils:</strong></p>
        <ul style="margin: 10px 0; padding-left: 20px;">
          <li *ngFor="let device of devicesInfo.authorizedDevices; let i = index">
            Appareil {{ i + 1 }}: <code style="background: #fff; padding: 2px 6px; border-radius: 3px;">{{ device }}</code>
          </li>
        </ul>
        <p *ngIf="devicesInfo.authorizedDevicesCount === 0" style="color: #d9534f;">
          ‚ö†Ô∏è Aucun appareil autoris√© - Il y a un probl√®me !
        </p>
        <p *ngIf="devicesInfo.authorizedDevicesCount > 2" style="color: #d9534f;">
          ‚ö†Ô∏è Plus de 2 appareils autoris√©s - Le blocage ne fonctionne pas !
        </p>
        <p *ngIf="devicesInfo.authorizedDevicesCount <= 2 && devicesInfo.authorizedDevicesCount > 0" style="color: #5cb85c;">
          ‚úÖ Configuration correcte
        </p>
      </div>
    </div>

    <!-- User Stats Section -->
    <section class="stats-section">
      <div class="user-card">
        <div class="user-header">
          <div class="avatar" (click)="triggerFileInput()" [class.has-picture]="profile.profilePicture">
            <img *ngIf="profile.profilePicture" [src]="profile.profilePicture" alt="Profile Picture" class="profile-picture">
            <span *ngIf="!profile.profilePicture" class="avatar-initial">{{ profile.name.charAt(0).toUpperCase() }}</span>
            <div class="avatar-overlay">
              <span class="camera-icon">üì∑</span>
            </div>
          </div>
          <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" style="display: none;">
          <div class="user-info">
            <h2>{{ profile.name }}</h2>
            <p class="semester">{{ profile.semester }}</p>
          </div>
        </div>

        <!-- Level Badge -->
        <div class="level-badge-container">
          <img [src]="getLevelInfo()?.image" [alt]="getLevelInfo()?.label" class="level-badge-image">
        </div>

        <!-- XP Progress -->
        <div class="xp-section">
          <div class="xp-header">
            <span class="xp-label">XP Total</span>
            <span class="xp-value">{{ profile.xpTotal }} XP</span>
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              [style.width.%]="getLevelInfo()?.progressPercent"
              [style.background]="getLevelInfo()?.color">
            </div>
          </div>
          <div class="xp-info">
            <span>{{ getLevelInfo()?.xpInLevel }} / {{ getLevelInfo()?.xpNeeded }} XP</span>
            <span *ngIf="getLevelInfo()?.nextLevel !== 'MAX'">
              Prochain: {{ getLevelInfo()?.nextLevel }}
            </span>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
          <div class="stat-item">
            <div class="stat-icon">üî•</div>
            <div class="stat-info">
              <span class="stat-value">{{ profile.consecutiveGoodAnswers }}</span>
              <span class="stat-label">S√©rie</span>
            </div>
          </div>
          <div class="stat-item">
            <div class="stat-icon">‚≠ê</div>
            <div class="stat-info">
              <span class="stat-value">{{ profile.legendQuestionsCompleted }}</span>
              <span class="stat-label">L√©gendaires</span>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button (click)="navigateToProfile()" class="btn btn-secondary">
            <span>üë§</span> Mon Profil
          </button>
          <button (click)="navigateToLeaderboard()" class="btn btn-primary">
            <span>üèÜ</span> Classement
          </button>
        </div>

        <!-- Logout Button -->
        <div class="logout-section">
          <button (click)="logout()" class="btn btn-logout">
            <span>üö™</span> Se d√©connecter
          </button>
        </div>
      </div>
    </section>

    <!-- Subjects Progress Section -->
    <section class="subjects-section">
      <h2 class="section-title">üìö Mes Mati√®res</h2>

      <div *ngIf="progress.length === 0" class="empty-state">
        <p>Aucune mati√®re disponible pour le moment</p>
      </div>

      <div class="subjects-grid">
        <div
          *ngFor="let subject of progress"
          class="subject-card"
          (click)="navigateToSubject(subject.subjectId)">

          <div class="subject-header">
            <h3>{{ subject.subjectName }}</h3>
            <span class="subject-badge">{{ subject.progressPercent }}%</span>
          </div>

          <div class="subject-stats">
            <div class="stat">
              <span class="stat-icon">üìù</span>
              <span class="stat-text">
                {{ subject.answeredQCM }} / {{ subject.totalQCM }} questions
              </span>
            </div>
            <div class="stat">
              <span class="stat-icon">üìñ</span>
              <span class="stat-text">
                {{ subject.chaptersCompleted }} / {{ subject.chaptersTotal }} chapitres
              </span>
            </div>
          </div>

          <div class="progress-bar subject-progress">
            <div
              class="progress-fill"
              [style.width.%]="subject.progressPercent">
            </div>
          </div>

          <!-- Unlock Status -->
          <div class="unlock-status">
            <span
              *ngIf="subject.progressPercent >= 50"
              class="unlock-badge unlock-challenge">
              üéØ Challenge d√©bloqu√©
            </span>
            <span
              *ngIf="subject.progressPercent >= 80"
              class="unlock-badge unlock-exam">
              üìù Examen d√©bloqu√©
            </span>
          </div>

          <button class="btn btn-start">
            Continuer
            <span class="arrow">‚Üí</span>
          </button>
        </div>
      </div>
    </section>
  </div>
</div>
