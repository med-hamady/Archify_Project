<div class="profile-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Chargement du profil...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-message">
    <p>{{ error }}</p>
    <button class="btn btn-primary" (click)="loadProfile()">R√©essayer</button>
  </div>

  <!-- Profile Content -->
  <div *ngIf="!loading && !error && profile" class="profile-content">

    <!-- Diagnostic Appareils -->
    <div *ngIf="devicesInfo" class="diagnostic-card">
      <h3>üîç Diagnostic - Appareils Autoris√©s</h3>
      <div class="diagnostic-content">
        <p><strong>Email:</strong> {{ devicesInfo.email }}</p>
        <p><strong>Nombre d'appareils autoris√©s:</strong> {{ devicesInfo.authorizedDevicesCount }} / 2</p>
        <p><strong>Appareils:</strong></p>
        <ul>
          <li *ngFor="let device of devicesInfo.authorizedDevices; let i = index">
            Appareil {{ i + 1 }}: <code>{{ device }}</code>
          </li>
        </ul>
        <p *ngIf="devicesInfo.authorizedDevicesCount === 0" class="error-status">
          ‚ö†Ô∏è Aucun appareil autoris√© - Il y a un probl√®me !
        </p>
        <p *ngIf="devicesInfo.authorizedDevicesCount > 2" class="error-status">
          ‚ö†Ô∏è Plus de 2 appareils autoris√©s - Le blocage ne fonctionne pas !
        </p>
        <p *ngIf="devicesInfo.authorizedDevicesCount <= 2 && devicesInfo.authorizedDevicesCount > 0" class="success-status">
          ‚úÖ Configuration correcte
        </p>
      </div>
    </div>

    <!-- Header Section -->
    <div class="profile-header">
      <div class="avatar-section">
        <div class="avatar-circle">
          <img *ngIf="profile.profilePicture" [src]="profile.profilePicture" alt="Photo de profil" class="profile-picture">
          <span *ngIf="!profile.profilePicture" class="avatar-initial">{{ profile.name.charAt(0).toUpperCase() }}</span>
        </div>
        <div class="level-badge-overlay" [style.background]="getLevelInfo()?.color">
          <img [src]="getLevelInfo()?.image" [alt]="getLevelInfo()?.label" class="level-badge-image">
        </div>
      </div>

      <div class="profile-info">
        <!-- Name with edit button -->
        <div class="name-section">
          <h1 *ngIf="!isEditingName">{{ profile.name }}</h1>
          <button *ngIf="!isEditingName" class="edit-name-btn" (click)="startEditingName()" title="Modifier le nom">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
            </svg>
          </button>

          <!-- Edit name form -->
          <form *ngIf="isEditingName" [formGroup]="editNameForm" (ngSubmit)="submitNameUpdate()" class="edit-name-form">
            <input
              type="text"
              formControlName="name"
              placeholder="Nouveau nom"
              class="name-input"
              [class.error]="editNameForm.get('name')?.invalid && editNameForm.get('name')?.touched"
            />
            <div class="edit-name-actions">
              <button type="submit" class="btn-save" [disabled]="editNameForm.invalid || nameUpdateLoading">
                <span *ngIf="!nameUpdateLoading">‚úì Sauvegarder</span>
                <span *ngIf="nameUpdateLoading">Enregistrement...</span>
              </button>
              <button type="button" class="btn-cancel" (click)="cancelEditingName()" [disabled]="nameUpdateLoading">
                ‚úï Annuler
              </button>
            </div>
            <div *ngIf="nameUpdateError" class="update-error">{{ nameUpdateError }}</div>
            <div *ngIf="nameUpdateSuccess" class="update-success">{{ nameUpdateSuccess }}</div>
            <div *ngIf="editNameForm.get('name')?.invalid && editNameForm.get('name')?.touched" class="validation-error">
              <span *ngIf="editNameForm.get('name')?.errors?.['required']">Le nom est requis</span>
              <span *ngIf="editNameForm.get('name')?.errors?.['minlength']">Le nom doit contenir au moins 2 caract√®res</span>
              <span *ngIf="editNameForm.get('name')?.errors?.['maxlength']">Le nom ne peut pas d√©passer 100 caract√®res</span>
            </div>
          </form>
        </div>

        <p class="email">{{ profile.email }}</p>
        <p class="semester">{{ profile.semester }}</p>

        <div class="quick-stats">
          <div class="stat-item">
            <span class="stat-value">{{ profile.xpTotal }}</span>
            <span class="stat-label">XP Total</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ getLevelInfo()?.label }}</span>
            <span class="stat-label">Niveau</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ profile.consecutiveGoodAnswers }}</span>
            <span class="stat-label">S√©rie</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ profile.legendQuestionsCompleted }}</span>
            <span class="stat-label">L√©gendes</span>
          </div>
        </div>

        <!-- XP Progress Bar -->
        <div class="xp-progress-section" *ngIf="getLevelInfo()">
          <div class="xp-info">
            <span>{{ getLevelInfo()?.xpInLevel }} / {{ getLevelInfo()?.xpNeeded }} XP</span>
            <span class="next-level">Prochain niveau: {{ getLevelInfo()?.label === 'Mondial' ? 'MAX' : getLevelInfo()?.label }}</span>
          </div>
          <div class="xp-bar">
            <div class="xp-fill" [style.width.%]="getLevelInfo()?.progressPercent"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Study Timer Section -->
    <div class="study-timer-card">
      <div class="timer-header">
        <h2>‚è±Ô∏è Chronom√®tre d'√âtude</h2>
        <span class="timer-subtitle">Gagne 60 XP chaque heure !</span>
      </div>

      <div class="timer-content">
        <!-- Session Timer -->
        <div class="current-session">
          <div class="session-label">Session actuelle</div>
          <div class="timer-display">{{ formatTime(elapsedSeconds) }}</div>
        </div>

        <!-- Progress to next reward -->
        <div class="reward-progress">
          <div class="progress-header">
            <span>Prochain XP dans: {{ getTimeUntilNextReward() }}</span>
            <span class="xp-badge">+60 XP</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="getProgressToNextHour()"></div>
          </div>
        </div>

        <!-- Total study time -->
        <div class="total-time">
          <div class="time-stat">
            <span class="stat-label">üìö Temps total d'√©tude</span>
            <span class="stat-value">{{ formatTime(getCombinedStudyTime()) }}</span>
          </div>
          <div class="time-stat">
            <span class="stat-label">üèÜ Heures compl√©t√©es</span>
            <span class="stat-value">{{ getTotalHours() }}h</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="tabs">
      <button
        class="tab-btn"
        [class.active]="activeTab === 'badges'"
        (click)="setActiveTab('badges')">
        <img width="24" height="24" src="https://img.icons8.com/external-flatarticons-blue-flatarticons/65/external-Badges-achievements-and-badges-flatarticons-blue-flatarticons.png" alt="badges"/> Badges
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'activity'"
        (click)="setActiveTab('activity')">
        <img width="24" height="24" src="https://img.icons8.com/parakeet/48/activity.png" alt="activity"/> Activit√©
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'stats'"
        (click)="setActiveTab('stats')">
        <img width="24" height="24" src="https://img.icons8.com/pastel-glyph/64/statistics--v1.png" alt="statistics"/> Statistiques
      </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">

      <!-- Badges Tab -->
      <div *ngIf="activeTab === 'badges'" class="badges-tab">
        <div class="badge-category" *ngIf="getBadgesByCategory('LEVEL').length > 0">
          <h2>üéñÔ∏è Badges de Niveau</h2>
          <div class="badges-grid">
            <div class="badge-card" *ngFor="let badge of getBadgesByCategory('LEVEL')">
              <div class="badge-icon">{{ badge.iconUrl || 'üèÜ' }}</div>
              <h3>{{ badge.name }}</h3>
              <p>{{ badge.description }}</p>
              <span class="earned-date" *ngIf="badge.earnedAt">
                Obtenu le {{ formatDate(badge.earnedAt) }}
              </span>
            </div>
          </div>
        </div>

        <div class="badge-category" *ngIf="getBadgesByCategory('ACHIEVEMENT').length > 0">
          <h2>‚≠ê Badges de Succ√®s</h2>
          <div class="badges-grid">
            <div class="badge-card" *ngFor="let badge of getBadgesByCategory('ACHIEVEMENT')">
              <div class="badge-icon">{{ badge.iconUrl || '‚≠ê' }}</div>
              <h3>{{ badge.name }}</h3>
              <p>{{ badge.description }}</p>
              <span class="earned-date" *ngIf="badge.earnedAt">
                Obtenu le {{ formatDate(badge.earnedAt) }}
              </span>
            </div>
          </div>
        </div>

        <div class="badge-category" *ngIf="getBadgesByCategory('SPECIAL').length > 0">
          <h2>üíé Badges Sp√©ciaux</h2>
          <div class="badges-grid">
            <div class="badge-card" *ngFor="let badge of getBadgesByCategory('SPECIAL')">
              <div class="badge-icon">{{ badge.iconUrl || 'üíé' }}</div>
              <h3>{{ badge.name }}</h3>
              <p>{{ badge.description }}</p>
              <span class="earned-date" *ngIf="badge.earnedAt">
                Obtenu le {{ formatDate(badge.earnedAt) }}
              </span>
            </div>
          </div>
        </div>

        <div *ngIf="badges.length === 0" class="empty-state">
          <p>Aucun badge obtenu pour le moment</p>
          <p class="hint">Continuez √† r√©pondre aux questions pour d√©bloquer des badges!</p>
        </div>
      </div>

      <!-- Activity Tab -->
      <div *ngIf="activeTab === 'activity'" class="activity-tab">
        <div class="activity-timeline">
          <div class="activity-item" *ngFor="let activity of activities">
            <div class="activity-icon">{{ getActivityIcon(activity.type) }}</div>
            <div class="activity-content">
              <p class="activity-description">{{ activity.description }}</p>
              <span class="activity-date">{{ formatDate(activity.createdAt) }}</span>
            </div>
            <div class="activity-xp" *ngIf="activity.xpEarned">
              <span>+{{ activity.xpEarned }} XP</span>
            </div>
          </div>
        </div>

        <div *ngIf="activities.length === 0" class="empty-state">
          <p>Aucune activit√© r√©cente</p>
          <p class="hint">Commencez √† jouer pour voir votre activit√© ici!</p>
        </div>
      </div>

      <!-- Stats Tab -->
      <div *ngIf="activeTab === 'stats'" class="stats-tab">
        <div class="stats-grid" *ngIf="stats">

          <!-- Overview Stats -->
          <div class="stat-card overview-card">
            <h3>üìä Vue d'ensemble</h3>
            <div class="stat-rows">
              <div class="stat-row">
                <span class="label">Questions totales:</span>
                <span class="value">{{ stats.totalQuestions }}</span>
              </div>
              <div class="stat-row">
                <span class="label">R√©ponses correctes:</span>
                <span class="value success">{{ stats.correctAnswers }}</span>
              </div>
              <div class="stat-row">
                <span class="label">R√©ponses incorrectes:</span>
                <span class="value error">{{ stats.incorrectAnswers }}</span>
              </div>
              <div class="stat-row">
                <span class="label">Taux de r√©ussite:</span>
                <span class="value highlight">{{ stats.successRate.toFixed(1) }}%</span>
              </div>
            </div>
          </div>

          <!-- Performance Stats -->
          <div class="stat-card performance-card">
            <h3>üéØ Performance</h3>
            <div class="stat-rows">
              <div class="stat-row">
                <span class="label">XP Total gagn√©:</span>
                <span class="value">{{ stats.totalXPEarned }}</span>
              </div>
              <div class="stat-row">
                <span class="label">Tentatives moyennes:</span>
                <span class="value">{{ stats.averageAttempts.toFixed(2) }}</span>
              </div>
              <div class="stat-row">
                <span class="label">Scores parfaits:</span>
                <span class="value highlight">{{ stats.perfectScores }}</span>
              </div>
            </div>
          </div>

          <!-- Challenge & Exam Stats -->
          <div class="stat-card modes-card">
            <h3>üéÆ Modes de jeu</h3>
            <div class="stat-rows">
              <div class="stat-row">
                <span class="label">Challenges compl√©t√©s:</span>
                <span class="value">{{ stats.challengesCompleted }}</span>
              </div>
              <div class="stat-row">
                <span class="label">Examens compl√©t√©s:</span>
                <span class="value">{{ stats.examsCompleted }}</span>
              </div>
              <div class="stat-row">
                <span class="label">Examens r√©ussis:</span>
                <span class="value success">{{ stats.examsPassed }}</span>
              </div>
            </div>
          </div>

        </div>

        <div *ngIf="!stats" class="empty-state">
          <p>Aucune statistique disponible</p>
        </div>
      </div>

    </div>

    <!-- Back to Dashboard Button -->
    <div class="actions">
      <button class="btn btn-secondary" routerLink="/dashboard">
        ‚Üê Retour au tableau de bord
      </button>
    </div>

  </div>
</div>
