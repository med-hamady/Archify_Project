<div class="challenge-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>{{ currentState === 'playing' ? 'Soumission en cours...' : 'Chargement du challenge...' }}</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-message">
    <div class="error-icon">‚ö†Ô∏è</div>
    <p>{{ error }}</p>
    <div class="error-actions">
      <button class="btn btn-secondary" (click)="backToChapters()">Retour aux chapitres</button>
      <button class="btn btn-primary" (click)="loadChallenge()">R√©essayer</button>
    </div>
  </div>

  <!-- Start Screen -->
  <div *ngIf="!loading && !error && currentState === 'start' && challenge" class="start-screen">
    <div class="start-card">
      <div class="challenge-icon">üéØ</div>
      <h1>Mode Challenge</h1>
      <h2>{{ challenge.chapterTitle }}</h2>

      <div class="challenge-info">
        <div class="info-item">
          <span class="info-icon">‚ùì</span>
          <span class="info-text">{{ challenge.totalQuestions }} questions</span>
        </div>
        <div class="info-item">
          <span class="info-icon">‚ö°</span>
          <span class="info-text">√ó1.5 XP Bonus</span>
        </div>
        <div class="info-item">
          <span class="info-icon">üèÜ</span>
          <span class="info-text">Score parfait = +100 XP</span>
        </div>
        <div class="info-item">
          <span class="info-icon">‚è±Ô∏è</span>
          <span class="info-text">1h de cooldown</span>
        </div>
      </div>

      <div class="rules">
        <h3>üìã R√®gles</h3>
        <ul>
          <li>R√©pondez √† toutes les questions en une session</li>
          <li>Vous pouvez naviguer entre les questions</li>
          <li>V√©rifiez vos r√©ponses avant de soumettre</li>
          <li>Bonus XP pour un score parfait!</li>
        </ul>
      </div>

      <!-- Timer Selection -->
      <div class="timer-selection">
        <h3>‚è±Ô∏è Temps limit√©</h3>
        <p class="timer-description">Choisissez votre limite de temps</p>
        <div class="time-options">
          <button
            *ngFor="let time of timeOptions"
            class="time-option"
            [class.selected]="selectedMinutes === time"
            (click)="selectedMinutes = time">
            {{ time }} min
          </button>
        </div>
        <p class="timer-hint">Le challenge sera automatiquement soumis quand le temps est √©coul√©</p>
      </div>

      <button class="btn btn-start" (click)="startPlaying()">
        Commencer le Challenge
        <span class="arrow">‚Üí</span>
      </button>
      <button class="btn btn-secondary" (click)="backToChapters()">Annuler</button>
    </div>
  </div>

  <!-- Playing Screen -->
  <div *ngIf="!loading && !error && currentState === 'playing' && challenge" class="playing-screen">

    <!-- Header -->
    <div class="playing-header">
      <div class="progress-info">
        <span class="question-counter">Question {{ currentQuestionIndex + 1 }} / {{ challenge.totalQuestions }}</span>
        <span class="answered-counter">R√©pondu: {{ getAnsweredCount() }} / {{ challenge.totalQuestions }}</span>
      </div>
      <div class="timer-display" [class.warning]="timeRemainingSeconds <= 60" [class.critical]="timeRemainingSeconds <= 30">
        <span class="timer-icon">‚è±Ô∏è</span>
        <span class="timer-text">{{ timerDisplay }}</span>
      </div>
      <div class="mini-progress">
        <div class="mini-progress-fill" [style.width.%]="(getAnsweredCount() / challenge.totalQuestions * 100)"></div>
      </div>
    </div>

    <!-- Question Card -->
    <div class="question-card" *ngIf="getCurrentQuestion()">
      <div class="question-header">
        <span class="question-number">#{{ currentQuestionIndex + 1 }}</span>
        <span class="difficulty-badge" [class]="getDifficultyClass(getCurrentQuestion()!.difficulty)">
          {{ getDifficultyLabel(getCurrentQuestion()!.difficulty) }}
        </span>
      </div>

      <div class="question-text">
        {{ getCurrentQuestion()!.questionText }}
      </div>

      <div class="options">
        <div
          *ngFor="let option of getCurrentQuestion()!.options; let i = index"
          class="option"
          [class.selected]="isAnswerSelected(i)"
          (click)="toggleAnswer(i)">
          <div class="option-checkbox">
            <input
              type="checkbox"
              [checked]="isAnswerSelected(i)"
              (click)="$event.stopPropagation()">
            <span class="option-letter">{{ ['A', 'B', 'C', 'D', 'E'][i] }}</span>
          </div>
          <div class="option-text">{{ option.text }}</div>
        </div>
      </div>

      <div class="hint-text">
        üí° Cochez une ou plusieurs r√©ponses, ou aucune si toutes sont fausses
      </div>
    </div>

    <!-- Navigation -->
    <div class="navigation">
      <button
        class="btn btn-secondary"
        [disabled]="currentQuestionIndex === 0"
        (click)="previousQuestion()">
        ‚Üê Pr√©c√©dent
      </button>

      <div class="question-dots">
        <div
          *ngFor="let q of challenge.questions; let i = index"
          class="question-dot"
          [class.current]="i === currentQuestionIndex"
          [class.answered]="answers[i].selectedAnswers.length > 0"
          (click)="goToQuestion(i)">
          {{ i + 1 }}
        </div>
      </div>

      <button
        class="btn btn-secondary"
        *ngIf="currentQuestionIndex < challenge.totalQuestions - 1"
        (click)="nextQuestion()">
        Suivant ‚Üí
      </button>

      <button
        class="btn btn-primary btn-submit"
        *ngIf="currentQuestionIndex === challenge.totalQuestions - 1"
        [disabled]="!canSubmit()"
        (click)="submitChallenge()">
        Soumettre üéØ
      </button>
    </div>
  </div>

  <!-- Results Screen -->
  <div *ngIf="!loading && !error && currentState === 'results' && result" class="results-screen">
    <div class="results-card">

      <!-- Result Header -->
      <div class="result-header">
        <div class="result-icon" [class.perfect]="result.score === result.questionsTotal">
          {{ result.score === result.questionsTotal ? 'üèÜ' : result.score >= result.questionsTotal * 0.7 ? '‚≠ê' : 'üìä' }}
        </div>
        <h1>{{ result.score === result.questionsTotal ? 'Score Parfait!' : 'Challenge Termin√©!' }}</h1>
        <div class="score-display">
          <span class="score">{{ result.score }}</span>
          <span class="separator">/</span>
          <span class="total">{{ result.questionsTotal }}</span>
        </div>
        <div class="percentage">{{ (result.score / result.questionsTotal * 100).toFixed(0) }}%</div>
      </div>

      <!-- XP Earned -->
      <div class="xp-earned-section">
        <div class="xp-item">
          <span class="xp-label">XP Gagn√©</span>
          <span class="xp-value">+{{ result.xpEarned }} XP</span>
        </div>
        <div class="xp-item bonus" *ngIf="result.xpBonus && result.xpBonus > 0">
          <span class="xp-label">Bonus Parfait</span>
          <span class="xp-value">+{{ result.xpBonus }} XP</span>
        </div>
        <div class="xp-item multiplier">
          <span class="xp-label">Multiplicateur</span>
          <span class="xp-value">√ó1.5</span>
        </div>
        <div class="xp-item total">
          <span class="xp-label">XP Total</span>
          <span class="xp-value">{{ result.totalXP }} XP</span>
        </div>
      </div>

      <!-- Level Up Alert -->
      <div class="alert alert-success" *ngIf="result.levelUp">
        <span class="alert-icon">üéâ</span>
        <span class="alert-text">
          Niveau augment√©: {{ result.levelUp.oldLevel }} ‚Üí {{ result.levelUp.newLevel }}!
        </span>
      </div>

      <!-- New Badges Alert -->
      <div class="alert alert-badge" *ngIf="result.newBadges && result.newBadges.length > 0">
        <span class="alert-icon">üèÖ</span>
        <span class="alert-text">
          {{ result.newBadges.length }} nouveau{{ result.newBadges.length > 1 ? 'x' : '' }} badge{{ result.newBadges.length > 1 ? 's' : '' }}!
        </span>
      </div>

      <!-- Question Results -->
      <div class="question-results">
        <h3>üìù D√©tails des r√©ponses</h3>
        <div class="results-list">
          <div
            *ngFor="let question of challenge!.questions; let i = index"
            class="result-item"
            [class.correct]="getQuestionResult(question.id)?.correct"
            [class.incorrect]="!getQuestionResult(question.id)?.correct">

            <div class="result-item-header">
              <span class="result-number">#{{ i + 1 }}</span>
              <span class="result-status">
                {{ getQuestionResult(question.id)?.correct ? '‚úÖ' : '‚ùå' }}
              </span>
            </div>

            <div class="result-question">{{ question.questionText }}</div>

            <div class="result-answer" *ngIf="!getQuestionResult(question.id)?.correct && getQuestionResult(question.id)?.options">
              <span class="answer-label">Bonne r√©ponse:</span>
              <div class="options-feedback">
                <div *ngFor="let option of getQuestionResult(question.id)?.options; let idx = index"
                     class="option-feedback"
                     [class.correct-option]="option.isCorrect"
                     [class.selected-option]="option.wasSelected">
                  <span class="option-letter">{{ ['A', 'B', 'C', 'D', 'E'][idx] }}</span>
                  <span class="option-text">{{ option.text }}</span>
                  <span *ngIf="option.isCorrect" class="correct-indicator">‚úì</span>
                  <span *ngIf="option.wasSelected && !option.isCorrect" class="wrong-indicator">‚úó</span>
                  <p *ngIf="!option.isCorrect && option.justification" class="justification">
                    {{ option.justification }}
                  </p>
                </div>
              </div>
            </div>

            <div class="result-explanation" *ngIf="getQuestionResult(question.id)?.explanation">
              <span class="explanation-label">üí° Explication:</span>
              <p>{{ getQuestionResult(question.id)?.explanation }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="result-actions">
        <button class="btn btn-secondary" (click)="backToChapters()">Retour aux chapitres</button>
        <button class="btn btn-primary" (click)="restartChallenge()">Nouveau Challenge</button>
      </div>
    </div>
  </div>

  <!-- XP Animation Overlay -->
  <div *ngIf="showXPAnimation" class="xp-animation">
    <div class="xp-popup">+{{ result?.xpEarned }} XP</div>
  </div>

  <!-- Level Up Animation Overlay -->
  <div *ngIf="showLevelUpAnimation && result?.levelUp" class="levelup-overlay">
    <div class="levelup-modal">
      <div class="levelup-icon">üéâ</div>
      <h2>Niveau augment√©!</h2>
      <div class="level-change">
        <span class="old-level">{{ result?.levelUp?.oldLevel }}</span>
        <span class="arrow">‚Üí</span>
        <span class="new-level">{{ result?.levelUp?.newLevel }}</span>
      </div>
    </div>
  </div>

  <!-- Badge Animation Overlay -->
  <div *ngIf="showBadgeAnimation && result?.newBadges" class="badge-overlay">
    <div class="badge-modal">
      <div class="badge-icon">üèÖ</div>
      <h2>Nouveau{{ (result?.newBadges?.length || 0) > 1 ? 'x' : '' }} Badge{{ (result?.newBadges?.length || 0) > 1 ? 's' : '' }}!</h2>
      <div class="badges-list">
        <div *ngFor="let badge of result?.newBadges" class="badge-item">
          <div class="badge-emoji">{{ badge.iconUrl || 'üèÜ' }}</div>
          <div class="badge-name">{{ badge.name }}</div>
          <div class="badge-desc">{{ badge.description }}</div>
        </div>
      </div>
    </div>
  </div>

</div>
