<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test Direct Vercel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1f2937;
            color: white;
        }
        .card {
            background: #374151;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
        }
        h1 { color: #60a5fa; }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #60a5fa;
            border-radius: 5px;
            background: #1f2937;
            color: white;
            font-size: 16px;
        }
        button {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        pre {
            background: #1f2937;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border: 1px solid #4b5563;
            color: #10b981;
        }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        code {
            background: #111827;
            padding: 2px 6px;
            border-radius: 3px;
            color: #10b981;
        }
    </style>
</head>
<body>
    <h1>üîç Test Direct du D√©ploiement Vercel</h1>

    <div class="card">
        <h2>√âtape 1 : Configuration</h2>
        <p>Entrez l'URL de votre application Vercel :</p>
        <input type="text" id="vercelUrl" placeholder="https://votre-app.vercel.app" value="">
        <p style="font-size: 12px; color: #9ca3af;">Ne mettez pas /admin √† la fin, juste l'URL de base</p>
    </div>

    <div class="card">
        <h2>√âtape 2 : Tests Automatiques</h2>
        <button onclick="testAll()">üöÄ Lancer TOUS les tests</button>
        <button onclick="testMainJS()">üì¶ Test 1 : V√©rifier main.js</button>
        <button onclick="testRuntimeJS()">‚ö° Test 2 : V√©rifier runtime.js</button>
        <button onclick="testPageSource()">üîé Test 3 : V√©rifier le HTML</button>

        <div id="results" style="margin-top: 20px;"></div>
    </div>

    <div class="card">
        <h2>üìã Instructions Manuelles</h2>
        <ol style="line-height: 1.8;">
            <li>Allez sur votre dashboard admin : <code>https://votre-app.vercel.app/admin</code></li>
            <li>Appuyez sur <code>F12</code> pour ouvrir les DevTools</li>
            <li>Allez dans l'onglet <strong>Console</strong></li>
            <li>Tapez cette commande :
                <pre>document.body.innerText.includes('Importer Mati√®re')</pre>
            </li>
            <li>Si r√©sultat = <span class="success">true</span> ‚Üí L'onglet existe dans le DOM</li>
            <li>Si r√©sultat = <span class="error">false</span> ‚Üí Le build Vercel n'est pas √† jour</li>
        </ol>
    </div>

    <div class="card">
        <h2>üîß Test Angular Build</h2>
        <p>Si les tests √©chouent, le probl√®me peut √™tre :</p>
        <ol style="line-height: 1.8;">
            <li><span class="warning">Angular build cache</span> : Vercel utilise l'ancien build</li>
            <li><span class="warning">Environment variables</span> : Mauvaise configuration</li>
            <li><span class="warning">Build command incorrect</span> : V√©rifier dans Vercel settings</li>
        </ol>

        <h3 style="margin-top: 20px;">Solution recommand√©e :</h3>
        <pre>1. Allez sur https://vercel.com/dashboard
2. S√©lectionnez votre projet FacGame
3. Settings ‚Üí General
4. V√©rifiez :
   - Build Command: npm run build (ou ng build)
   - Output Directory: dist/frontend/browser
   - Install Command: npm install
5. Deployments ‚Üí Latest ‚Üí Trois points (...) ‚Üí Redeploy
6. Cochez "Use existing build cache" = D√âCOCH√â
7. Cliquez "Redeploy"</pre>
    </div>

    <script>
        function getUrl() {
            const url = document.getElementById('vercelUrl').value.trim();
            if (!url) {
                alert('‚ö†Ô∏è Veuillez entrer l\'URL Vercel');
                return null;
            }
            return url.replace(/\/$/, '');
        }

        async function testMainJS() {
            const url = getUrl();
            if (!url) return;

            const results = document.getElementById('results');
            results.innerHTML = '<p class="warning">‚è≥ Test 1 en cours...</p>';

            try {
                const response = await fetch(`${url}/main.js`);
                const text = await response.text();

                const hasImportTab = text.includes('Importer Mati√®re') || text.includes('import-subject');

                if (hasImportTab) {
                    results.innerHTML += '<p class="success">‚úÖ Test 1 R√âUSSI : main.js contient "Importer Mati√®re"</p>';
                } else {
                    results.innerHTML += '<p class="error">‚ùå Test 1 √âCHOU√â : main.js NE contient PAS "Importer Mati√®re"</p>';
                    results.innerHTML += '<p class="warning">‚ö†Ô∏è Le build Vercel n\'est pas √† jour. Il faut red√©ployer SANS cache.</p>';
                }
            } catch (error) {
                results.innerHTML += `<p class="error">‚ùå Erreur : ${error.message}</p>`;
            }
        }

        async function testRuntimeJS() {
            const url = getUrl();
            if (!url) return;

            const results = document.getElementById('results');
            results.innerHTML += '<p class="warning">‚è≥ Test 2 en cours...</p>';

            try {
                // Try to fetch any chunk files
                const indexResponse = await fetch(`${url}/index.html`);
                const indexHtml = await indexResponse.text();

                // Extract script tags
                const scriptMatches = indexHtml.match(/<script[^>]*src="([^"]*)"[^>]*>/g);

                if (scriptMatches) {
                    results.innerHTML += `<p class="success">‚úÖ Test 2 : Trouv√© ${scriptMatches.length} fichiers JavaScript</p>`;
                    results.innerHTML += `<pre>${scriptMatches.join('\n')}</pre>`;
                } else {
                    results.innerHTML += '<p class="error">‚ùå Aucun script trouv√© dans index.html</p>';
                }
            } catch (error) {
                results.innerHTML += `<p class="error">‚ùå Erreur : ${error.message}</p>`;
            }
        }

        async function testPageSource() {
            const url = getUrl();
            if (!url) return;

            const results = document.getElementById('results');
            results.innerHTML += '<p class="warning">‚è≥ Test 3 en cours...</p>';

            try {
                const response = await fetch(`${url}/admin`);
                const html = await response.text();

                const hasImportTab = html.includes('Importer Mati√®re') || html.includes('import-subject');

                if (hasImportTab) {
                    results.innerHTML += '<p class="success">‚úÖ Test 3 R√âUSSI : La page /admin contient "Importer Mati√®re"</p>';
                } else {
                    results.innerHTML += '<p class="error">‚ùå Test 3 √âCHOU√â : La page /admin NE contient PAS "Importer Mati√®re"</p>';
                    results.innerHTML += '<p class="warning">‚ö†Ô∏è Angular n\'a pas inclus l\'onglet dans le build.</p>';
                }

                // Check if it's an Angular app
                if (html.includes('ng-version') || html.includes('app-root')) {
                    results.innerHTML += '<p class="success">‚úÖ Application Angular d√©tect√©e</p>';
                } else {
                    results.innerHTML += '<p class="warning">‚ö†Ô∏è Pas d\'application Angular d√©tect√©e (SSR possible)</p>';
                }
            } catch (error) {
                results.innerHTML += `<p class="error">‚ùå Erreur : ${error.message}</p>`;
            }
        }

        async function testAll() {
            const results = document.getElementById('results');
            results.innerHTML = '<h3 class="warning">üîç Tests en cours...</h3>';

            await testMainJS();
            await new Promise(r => setTimeout(r, 1000));
            await testRuntimeJS();
            await new Promise(r => setTimeout(r, 1000));
            await testPageSource();

            results.innerHTML += '<hr style="border-color: #4b5563; margin: 20px 0;">';
            results.innerHTML += '<h3>üìä Diagnostic :</h3>';
            results.innerHTML += `
                <p><strong>Si TOUS les tests √©chouent :</strong></p>
                <ul style="line-height: 1.8;">
                    <li>Le build Vercel utilise l'ancien code</li>
                    <li>Solution : Red√©ployer SANS cache sur Vercel</li>
                </ul>
                <p style="margin-top: 15px;"><strong>Si certains tests r√©ussissent :</strong></p>
                <ul style="line-height: 1.8;">
                    <li>Le code est pr√©sent mais Angular ne le charge pas</li>
                    <li>V√©rifier les routes Angular et le lazy loading</li>
                </ul>
            `;
        }

        // Auto-populate if on same domain
        if (window.location.hostname !== 'localhost') {
            document.getElementById('vercelUrl').value = `${window.location.protocol}//${window.location.hostname}`;
        }
    </script>
</body>
</html>
