import { PrismaClient } from '@prisma/client';
import bcrypt from 'bcryptjs';

const prisma = new PrismaClient();

async function main() {
  console.log('ðŸŒ± Starting FacGame database seeding...');

  // ============================================
  // 1. SUBSCRIPTION PLANS
  // ============================================
  const plans = await Promise.all([
    prisma.subscriptionPlan.upsert({
      where: { id: 'quiz-only-plan' },
      update: {},
      create: {
        id: 'quiz-only-plan',
        name: 'Quiz uniquement',
        description: 'AccÃ¨s illimitÃ© aux quiz interactifs FacGame',
        type: 'QUIZ_ONLY',
        interval: 'yearly',
        priceCents: 30000, // 300 MRU par an
        currency: 'MRU',
        features: [
          'AccÃ¨s Ã  tous les quiz interactifs',
          'SystÃ¨me de gamification complet',
          'Modes Challenge et Examen',
          'Classement et badges',
          'Valable pendant 1 an'
        ],
        isActive: true
      }
    }),
    prisma.subscriptionPlan.upsert({
      where: { id: 'documents-only-plan' },
      update: {},
      create: {
        id: 'documents-only-plan',
        name: 'Documents uniquement',
        description: 'AccÃ¨s aux cours PDF',
        type: 'DOCUMENTS_ONLY',
        interval: 'yearly',
        priceCents: 20000, // 200 MRU par an
        currency: 'MRU',
        features: [
          'AccÃ¨s Ã  tous les documents PDF',
          'TÃ©lÃ©chargement des cours',
          'Valable pendant 1 an'
        ],
        isActive: true
      }
    }),
    prisma.subscriptionPlan.upsert({
      where: { id: 'full-access-plan' },
      update: {},
      create: {
        id: 'full-access-plan',
        name: 'AccÃ¨s complet',
        description: 'AccÃ¨s total : Quiz + Documents PDF',
        type: 'FULL_ACCESS',
        interval: 'yearly',
        priceCents: 40000, // 400 MRU par an
        currency: 'MRU',
        features: [
          'Tous les quiz interactifs',
          'Tous les documents PDF',
          'SystÃ¨me de gamification',
          'Modes Challenge et Examen',
          'Classement et badges',
          'Support prioritaire',
          'Valable pendant 1 an'
        ],
        isActive: true
      }
    })
  ]);

  console.log('âœ… Subscription plans created');

  // ============================================
  // 2. USERS
  // ============================================
  const adminPassword = await bcrypt.hash('admin123', 10);
  const admin = await prisma.user.upsert({
    where: { email: 'admin@facgame.ma' },
    update: {},
    create: {
      email: 'admin@facgame.ma',
      passwordHash: adminPassword,
      name: 'Administrateur FacGame',
      role: 'SUPERADMIN',
      semester: '1'
    }
  });

  const studentPassword = await bcrypt.hash('student123', 10);
  const student = await prisma.user.upsert({
    where: { email: 'student@facgame.ma' },
    update: {},
    create: {
      email: 'student@facgame.ma',
      passwordHash: studentPassword,
      name: 'Mohamed Ã‰tudiant',
      role: 'STUDENT',
      semester: '1',
      xpTotal: 150,
      level: 'BOIS',
      consecutiveGoodAnswers: 0,
      legendQuestionsCompleted: 0
    }
  });

  console.log('âœ… Users created');

  // ============================================
  // 3. BADGES
  // ============================================
  const badges = await Promise.all([
    prisma.badge.upsert({
      where: { name: 'Niveau Bronze' },
      update: {},
      create: {
        name: 'Niveau Bronze',
        description: 'Atteindre le niveau Bronze (801+ XP)',
        requirement: 'REACH_BRONZE'
      }
    }),
    prisma.badge.upsert({
      where: { name: 'Niveau Argent' },
      update: {},
      create: {
        name: 'Niveau Argent',
        description: 'Atteindre le niveau Argent (1601+ XP)',
        requirement: 'REACH_ARGENT'
      }
    }),
    prisma.badge.upsert({
      where: { name: 'Niveau Or' },
      update: {},
      create: {
        name: 'Niveau Or',
        description: 'Atteindre le niveau Or (2801+ XP)',
        requirement: 'REACH_OR'
      }
    }),
    prisma.badge.upsert({
      where: { name: 'Niveau Platinum' },
      update: {},
      create: {
        name: 'Niveau Platinum',
        description: 'Atteindre le niveau Platinum (4001+ XP)',
        requirement: 'REACH_PLATINUM'
      }
    }),
    prisma.badge.upsert({
      where: { name: 'Niveau LÃ©gendaire' },
      update: {},
      create: {
        name: 'Niveau LÃ©gendaire',
        description: 'Atteindre le niveau LÃ©gendaire (5501+ XP)',
        requirement: 'REACH_LEGENDAIRE'
      }
    }),
    prisma.badge.upsert({
      where: { name: 'Niveau Mondial' },
      update: {},
      create: {
        name: 'Niveau Mondial',
        description: 'Atteindre le niveau Mondial (9001+ XP)',
        requirement: 'REACH_MONDIAL'
      }
    }),
    prisma.badge.upsert({
      where: { name: 'MaÃ®tre des LÃ©gendes' },
      update: {},
      create: {
        name: 'MaÃ®tre des LÃ©gendes',
        description: 'RÃ©ussir 100 questions lÃ©gendaires',
        requirement: 'COMPLETE_100_LEGEND_QCM'
      }
    }),
    prisma.badge.upsert({
      where: { name: 'SÃ©rie de 5' },
      update: {},
      create: {
        name: 'SÃ©rie de 5',
        description: '5 bonnes rÃ©ponses consÃ©cutives',
        requirement: 'STREAK_5_CORRECT'
      }
    }),
    prisma.badge.upsert({
      where: { name: 'SÃ©rie de 10' },
      update: {},
      create: {
        name: 'SÃ©rie de 10',
        description: '10 bonnes rÃ©ponses consÃ©cutives',
        requirement: 'STREAK_10_CORRECT'
      }
    }),
    prisma.badge.upsert({
      where: { name: 'Challenge Parfait' },
      update: {},
      create: {
        name: 'Challenge Parfait',
        description: 'RÃ©ussir un challenge Ã  100%',
        requirement: 'CHALLENGE_100_PERCENT'
      }
    }),
    prisma.badge.upsert({
      where: { name: 'Premier Examen RÃ©ussi' },
      update: {},
      create: {
        name: 'Premier Examen RÃ©ussi',
        description: 'RÃ©ussir votre premier examen (note â‰¥ 10/20)',
        requirement: 'FIRST_EXAM_PASSED'
      }
    }),
    prisma.badge.upsert({
      where: { name: 'Chapitre Parfait' },
      update: {},
      create: {
        name: 'Chapitre Parfait',
        description: 'ComplÃ©ter un chapitre avec 100% de rÃ©ussite',
        requirement: 'PERFECT_CHAPTER'
      }
    })
  ]);

  console.log('âœ… Badges created');

  // ============================================
  // 4. SUBJECTS (MatiÃ¨res mÃ©dicales)
  // ============================================
  const subjects = await Promise.all([
    prisma.subject.upsert({
      where: { id: 'subject-anatomie' },
      update: {},
      create: {
        id: 'subject-anatomie',
        title: 'Anatomie',
        description: 'Ã‰tude de la structure du corps humain : ostÃ©ologie, myologie, articulations et systÃ¨mes',
        semester: 'S1',
        tags: ['Anatomie', 'OstÃ©ologie', 'Myologie', 'Articulations'],
        totalQCM: 600
      }
    }),
    prisma.subject.upsert({
      where: { id: 'subject-histologie' },
      update: {},
      create: {
        id: 'subject-histologie',
        title: 'Histologie',
        description: 'Ã‰tude des tissus du corps humain au niveau microscopique',
        semester: 'S1',
        tags: ['Histologie', 'Tissus', 'Cellules', 'Microscopie'],
        totalQCM: 600
      }
    }),
    prisma.subject.upsert({
      where: { id: 'subject-physiologie' },
      update: {},
      create: {
        id: 'subject-physiologie',
        title: 'Physiologie',
        description: 'Ã‰tude des fonctions vitales, systÃ¨mes et rÃ©gulations du corps humain',
        semester: 'S2',
        tags: ['Physiologie', 'Fonctions vitales', 'HomÃ©ostasie', 'RÃ©gulation'],
        totalQCM: 600
      }
    })
  ]);

  console.log('âœ… Subjects created');

  // ============================================
  // 5. CHAPTERS (Chapitres dans chaque matiÃ¨re)
  // ============================================

  // Chapitres Anatomie
  const anatomieChapters = await Promise.all([
    prisma.chapter.upsert({
      where: { id: 'chapter-anatomie-1' },
      update: {},
      create: {
        id: 'chapter-anatomie-1',
        subjectId: subjects[0].id,
        title: 'OstÃ©ologie du crÃ¢ne',
        description: 'Ã‰tude des os du crÃ¢ne et leurs articulations',
        orderIndex: 1,
        pdfUrl: 'https://example.com/anatomie-crane.pdf'
      }
    }),
    prisma.chapter.upsert({
      where: { id: 'chapter-anatomie-2' },
      update: {},
      create: {
        id: 'chapter-anatomie-2',
        subjectId: subjects[0].id,
        title: 'Myologie du membre supÃ©rieur',
        description: 'Muscles du membre supÃ©rieur : origine, insertion, action',
        orderIndex: 2,
        pdfUrl: 'https://example.com/anatomie-membre-sup.pdf'
      }
    }),
    prisma.chapter.upsert({
      where: { id: 'chapter-anatomie-3' },
      update: {},
      create: {
        id: 'chapter-anatomie-3',
        subjectId: subjects[0].id,
        title: 'SystÃ¨me cardiovasculaire',
        description: 'Anatomie du cÅ“ur et des vaisseaux sanguins',
        orderIndex: 3
      }
    })
  ]);

  // Chapitres Histologie
  const histologieChapters = await Promise.all([
    prisma.chapter.upsert({
      where: { id: 'chapter-histologie-1' },
      update: {},
      create: {
        id: 'chapter-histologie-1',
        subjectId: subjects[1].id,
        title: 'Tissus Ã©pithÃ©liaux',
        description: 'Classification et caractÃ©ristiques des Ã©pithÃ©liums',
        orderIndex: 1,
        pdfUrl: 'https://example.com/histologie-epithelium.pdf'
      }
    }),
    prisma.chapter.upsert({
      where: { id: 'chapter-histologie-2' },
      update: {},
      create: {
        id: 'chapter-histologie-2',
        subjectId: subjects[1].id,
        title: 'Tissus conjonctifs',
        description: 'Ã‰tude des tissus conjonctifs et leurs composants',
        orderIndex: 2
      }
    })
  ]);

  // Chapitres Physiologie
  const physiologieChapters = await Promise.all([
    prisma.chapter.upsert({
      where: { id: 'chapter-physiologie-1' },
      update: {},
      create: {
        id: 'chapter-physiologie-1',
        subjectId: subjects[2].id,
        title: 'Physiologie cardiaque',
        description: 'Fonctionnement du cÅ“ur et rÃ©gulation cardiovasculaire',
        orderIndex: 1,
        pdfUrl: 'https://example.com/physio-cardiaque.pdf'
      }
    })
  ]);

  console.log('âœ… Chapters created');

  // ============================================
  // 6. QUESTIONS (Exemples de QCM)
  // ============================================

  // Questions Anatomie - Chapitre 1 (OstÃ©ologie du crÃ¢ne)
  await Promise.all([
    prisma.question.create({
      data: {
        chapterId: anatomieChapters[0].id,
        questionText: 'Combien d\'os composent le crÃ¢ne humain adulte ?',
        options: ['18 os', '22 os', '26 os', '30 os'],
        correctAnswer: 1, // 22 os
        explanation: 'Le crÃ¢ne humain adulte est composÃ© de 22 os : 8 os du neurocrÃ¢ne et 14 os de la face.',
        difficulty: 'FACILE',
        orderIndex: 1
      }
    }),
    prisma.question.create({
      data: {
        chapterId: anatomieChapters[0].id,
        questionText: 'Quel os forme la partie postÃ©rieure et infÃ©rieure du crÃ¢ne ?',
        options: ['L\'os frontal', 'L\'os pariÃ©tal', 'L\'os occipital', 'L\'os temporal'],
        correctAnswer: 2, // L'os occipital
        explanation: 'L\'os occipital forme la partie postÃ©ro-infÃ©rieure du crÃ¢ne et contient le foramen magnum.',
        difficulty: 'FACILE',
        orderIndex: 2
      }
    }),
    prisma.question.create({
      data: {
        chapterId: anatomieChapters[0].id,
        questionText: 'Quelle suture sÃ©pare l\'os frontal des os pariÃ©taux ?',
        options: ['Suture coronale', 'Suture sagittale', 'Suture lambdoÃ¯de', 'Suture squameuse'],
        correctAnswer: 0, // Suture coronale
        explanation: 'La suture coronale sÃ©pare l\'os frontal des deux os pariÃ©taux.',
        difficulty: 'MOYEN',
        orderIndex: 3
      }
    }),
    prisma.question.create({
      data: {
        chapterId: anatomieChapters[0].id,
        questionText: 'Le processus mastoÃ¯de fait partie de quel os ?',
        options: ['Os occipital', 'Os temporal', 'Os sphÃ©noÃ¯de', 'Os ethmoÃ¯de'],
        correctAnswer: 1, // Os temporal
        explanation: 'Le processus mastoÃ¯de est une saillie de l\'os temporal, situÃ©e en arriÃ¨re de l\'oreille.',
        difficulty: 'MOYEN',
        orderIndex: 4
      }
    }),
    prisma.question.create({
      data: {
        chapterId: anatomieChapters[0].id,
        questionText: 'Quels sont les trois types de cellules prÃ©sentes dans la lame criblÃ©e de l\'ethmoÃ¯de ?',
        options: [
          'Cellules olfactives, cellules de soutien, cellules basales',
          'Cellules antÃ©rieures, moyennes et postÃ©rieures',
          'Cellules ethmoÃ¯dales, sphÃ©noÃ¯dales et frontales',
          'Cellules neurosÃ©crÃ©toires, gliales et Ã©pithÃ©liales'
        ],
        correctAnswer: 1, // Cellules antÃ©rieures, moyennes et postÃ©rieures
        explanation: 'Les cellules ethmoÃ¯dales sont classÃ©es en trois groupes : antÃ©rieures, moyennes et postÃ©rieures selon leur position.',
        difficulty: 'DIFFICILE',
        orderIndex: 5
      }
    }),
    prisma.question.create({
      data: {
        chapterId: anatomieChapters[0].id,
        questionText: 'DÃ©crivez le trajet complet du nerf trijumeau (V) depuis le tronc cÃ©rÃ©bral jusqu\'Ã  ses trois branches terminales, en prÃ©cisant les foramens osseux traversÃ©s.',
        options: [
          'Sort par foramen ovale (V1), foramen rond (V2), fissure orbitaire supÃ©rieure (V3)',
          'Sort par fissure orbitaire supÃ©rieure (V1), foramen rond (V2), foramen ovale (V3)',
          'Sort par foramen magnum puis se divise en trois branches crÃ¢niennes',
          'Traverse le canal du nerf hypoglosse puis Ã©merge par trois foramens diffÃ©rents'
        ],
        correctAnswer: 1,
        explanation: 'Le nerf trijumeau se divise en trois branches : V1 (ophtalmique) par la fissure orbitaire supÃ©rieure, V2 (maxillaire) par le foramen rond, et V3 (mandibulaire) par le foramen ovale.',
        difficulty: 'LEGENDE',
        orderIndex: 6
      }
    })
  ]);

  // Questions Histologie - Chapitre 1 (Tissus Ã©pithÃ©liaux)
  await Promise.all([
    prisma.question.create({
      data: {
        chapterId: histologieChapters[0].id,
        questionText: 'Quelle est la caractÃ©ristique principale d\'un Ã©pithÃ©lium ?',
        options: [
          'PrÃ©sence de vaisseaux sanguins',
          'Cellules jointives avec peu de matrice extracellulaire',
          'Abondance de fibres de collagÃ¨ne',
          'Cellules espacÃ©es dans une matrice abondante'
        ],
        correctAnswer: 1,
        explanation: 'Les Ã©pithÃ©liums sont caractÃ©risÃ©s par des cellules jointives (peu d\'espace intercellulaire) et une matrice extracellulaire rÃ©duite.',
        difficulty: 'FACILE',
        orderIndex: 1
      }
    }),
    prisma.question.create({
      data: {
        chapterId: histologieChapters[0].id,
        questionText: 'Quel type d\'Ã©pithÃ©lium tapisse la vessie ?',
        options: [
          'Ã‰pithÃ©lium simple cubique',
          'Ã‰pithÃ©lium stratifiÃ© squameux',
          'Ã‰pithÃ©lium de transition (urothÃ©lium)',
          'Ã‰pithÃ©lium pseudostratifiÃ©'
        ],
        correctAnswer: 2,
        explanation: 'La vessie est tapissÃ©e par un Ã©pithÃ©lium de transition (urothÃ©lium) qui peut s\'Ã©tirer lors du remplissage vÃ©sical.',
        difficulty: 'MOYEN',
        orderIndex: 2
      }
    })
  ]);

  // Questions Physiologie - Chapitre 1 (Physiologie cardiaque)
  await Promise.all([
    prisma.question.create({
      data: {
        chapterId: physiologieChapters[0].id,
        questionText: 'Quelle est la frÃ©quence cardiaque normale au repos chez un adulte ?',
        options: ['40-60 bpm', '60-100 bpm', '100-120 bpm', '120-140 bpm'],
        correctAnswer: 1,
        explanation: 'La frÃ©quence cardiaque normale au repos chez un adulte se situe entre 60 et 100 battements par minute.',
        difficulty: 'FACILE',
        orderIndex: 1
      }
    }),
    prisma.question.create({
      data: {
        chapterId: physiologieChapters[0].id,
        questionText: 'Quel est le pacemaker naturel du cÅ“ur ?',
        options: [
          'NÅ“ud auriculo-ventriculaire (NAV)',
          'Faisceau de His',
          'NÅ“ud sinusal (NS)',
          'Fibres de Purkinje'
        ],
        correctAnswer: 2,
        explanation: 'Le nÅ“ud sinusal (ou nÅ“ud sino-atrial) est le pacemaker naturel du cÅ“ur, situÃ© dans l\'oreillette droite.',
        difficulty: 'MOYEN',
        orderIndex: 2
      }
    })
  ]);

  console.log('âœ… Sample questions created');

  // ============================================
  // 7. TEST SUBSCRIPTION
  // ============================================
  await prisma.subscription.upsert({
    where: { id: 'sub-student-1' },
    update: {},
    create: {
      id: 'sub-student-1',
      userId: student.id,
      planId: plans[2].id, // Full access
      status: 'ACTIVE',
      startAt: new Date(),
      endAt: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000) // 1 year
    }
  });

  console.log('âœ… Test subscription created');

  // ============================================
  // SUMMARY
  // ============================================
  console.log('\nðŸŽ‰ FacGame database seeding completed successfully!\n');
  console.log('ðŸ“‹ Test accounts:');
  console.log('   Admin: admin@facgame.ma / admin123');
  console.log('   Student: student@facgame.ma / student123\n');
  console.log('ðŸ“Š Data created:');
  console.log(`   - ${plans.length} subscription plans`);
  console.log(`   - ${badges.length} badges`);
  console.log(`   - ${subjects.length} subjects (matiÃ¨res)`);
  console.log(`   - ${anatomieChapters.length + histologieChapters.length + physiologieChapters.length} chapters`);
  console.log('   - 10 sample questions (QCM)\n');
}

main()
  .catch((e) => {
    console.error('âŒ Error during seeding:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
