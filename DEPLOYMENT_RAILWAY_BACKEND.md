# üöÇ D√©ploiement du Backend Archify sur Railway

## üìã Pr√©requis

- ‚úÖ Compte GitHub avec le repository `Archify_Project`
- ‚úÖ Fichiers de configuration cr√©√©s (`railway.json`, `Procfile`)
- ‚úÖ Backend fonctionnel en local

---

## üéØ √âtape 1 : Cr√©er un Compte Railway

1. **Aller sur** : https://railway.app
2. **Cliquer sur** "Start a New Project"
3. **Se connecter avec GitHub** (recommand√©)
4. **Autoriser Railway** √† acc√©der √† vos repositories

---

## üöÄ √âtape 2 : Cr√©er un Nouveau Projet

### A. Depuis l'Interface Railway

1. **Cliquer sur** "New Project"
2. **S√©lectionner** "Deploy from GitHub repo"
3. **Choisir** le repository `Archify_Project`
4. **Railway va d√©tecter** automatiquement que c'est un projet Node.js

### B. Configuration Automatique

Railway va :
- ‚úÖ D√©tecter `package.json` dans `/backend`
- ‚úÖ Installer les d√©pendances avec `npm install`
- ‚úÖ Compiler TypeScript avec `npm run build`
- ‚úÖ D√©marrer le serveur avec `npm start`

---

## üóÑÔ∏è √âtape 3 : Ajouter PostgreSQL

### A. Cr√©er la Base de Donn√©es

1. **Dans votre projet Railway**, cliquer sur "+ New"
2. **S√©lectionner** "Database"
3. **Choisir** "PostgreSQL"
4. **Railway va cr√©er** automatiquement une instance PostgreSQL

### B. Variables d'Environnement Automatiques

Railway cr√©e automatiquement ces variables :
```
PGHOST=containers-us-west-xxx.railway.app
PGPORT=5432
PGUSER=postgres
PGPASSWORD=xxxxxxxxxxxxx
PGDATABASE=railway
DATABASE_URL=postgresql://postgres:xxxxx@containers-us-west-xxx.railway.app:5432/railway
```

---

## ‚öôÔ∏è √âtape 4 : Configurer les Variables d'Environnement

### A. Dans Railway Dashboard

1. **Cliquer sur votre service backend**
2. **Aller dans** "Variables"
3. **Ajouter les variables suivantes** :

```env
# Database (Railway g√©n√®re DATABASE_URL automatiquement)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# JWT Secret (g√©n√©rer une cl√© al√©atoire s√©curis√©e)
JWT_SECRET=votre-super-secret-key-ici-changez-moi-123456789

# Email Configuration (pour l'envoi d'emails)
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=votre-email@gmail.com
EMAIL_PASSWORD=votre-mot-de-passe-app

# Environment
NODE_ENV=production

# Port (Railway utilise PORT automatiquement)
PORT=${{PORT}}

# CORS Origins (URL de votre frontend Vercel)
FRONTEND_URL=https://archify-project.vercel.app
```

### B. R√©f√©rence des Variables

**Variables Obligatoires** :
- ‚úÖ `DATABASE_URL` - Connexion PostgreSQL (auto-g√©n√©r√©e)
- ‚úÖ `JWT_SECRET` - Cl√© secr√®te pour les tokens JWT
- ‚úÖ `NODE_ENV` - Environnement de production
- ‚úÖ `PORT` - Port du serveur (auto-assign√© par Railway)

**Variables Optionnelles** :
- `EMAIL_HOST` - Serveur SMTP pour l'envoi d'emails
- `EMAIL_PORT` - Port SMTP
- `EMAIL_USER` - Adresse email d'envoi
- `EMAIL_PASSWORD` - Mot de passe de l'email
- `FRONTEND_URL` - URL du frontend pour CORS

---

## üîß √âtape 5 : Configurer le Service Backend

### A. Settings du Service

1. **Dans Railway**, cliquer sur votre service backend
2. **Aller dans** "Settings"
3. **Configurer** :

**Root Directory** :
```
backend
```

**Build Command** (optionnel, Railway d√©tecte automatiquement) :
```bash
npm install && npm run build
```

**Start Command** (optionnel, Railway d√©tecte automatiquement) :
```bash
npm start
```

**Watch Paths** (optionnel) :
```
backend/**
```
*Cela red√©ploiera automatiquement si des fichiers dans `/backend` changent*

---

## üîó √âtape 6 : Connecter la Base de Donn√©es

### A. Lier PostgreSQL au Backend

1. **Cliquer sur votre service backend**
2. **Aller dans** "Variables"
3. **Cliquer sur** "+ New Variable"
4. **S√©lectionner** "Reference" ‚Üí `Postgres.DATABASE_URL`
5. **Railway va automatiquement** mettre √† jour `DATABASE_URL`

### B. V√©rifier la Connexion

Railway va automatiquement :
- ‚úÖ Injecter `DATABASE_URL` dans votre backend
- ‚úÖ Prisma va utiliser cette variable pour se connecter
- ‚úÖ Les migrations seront appliqu√©es (si configur√©es)

---

## üì¶ √âtape 7 : Ex√©cuter les Migrations Prisma

### Option 1 : Via Railway CLI (Recommand√©)

#### Installation de Railway CLI

```bash
npm install -g @railway/cli
```

#### Connexion

```bash
railway login
```

#### Lier au Projet

```bash
cd c:/Users/pc/Desktop/Archify_Project
railway link
```

**Choisir** :
- Votre compte Railway
- Le projet `Archify_Project`
- Le service `backend`

#### Ex√©cuter les Migrations

```bash
railway run npx prisma migrate deploy
```

#### G√©n√©rer le Client Prisma

```bash
railway run npx prisma generate
```

---

### Option 2 : Ajouter les Migrations au Build

**Modifier** : `backend/package.json`

```json
{
  "scripts": {
    "build": "prisma generate && tsc -p tsconfig.json",
    "start": "prisma migrate deploy && node dist/index.js"
  }
}
```

**Attention** : Cette m√©thode ex√©cute les migrations √† chaque d√©marrage.

---

### Option 3 : Via Railway Dashboard (One-off Command)

1. **Dans Railway**, cliquer sur votre service backend
2. **Aller dans** "Deployments"
3. **Cliquer sur les trois points** (...) du d√©ploiement
4. **S√©lectionner** "Open Shell"
5. **Ex√©cuter** :
```bash
cd backend
npx prisma migrate deploy
npx prisma generate
```

---

## üåê √âtape 8 : Obtenir l'URL du Backend

### A. URL Publique

1. **Dans Railway**, cliquer sur votre service backend
2. **Aller dans** "Settings"
3. **Trouver** "Domains"
4. **Cliquer sur** "Generate Domain"

Railway va g√©n√©rer une URL comme :
```
https://archify-backend-production.up.railway.app
```

### B. URL Personnalis√©e (Optionnel)

Vous pouvez ajouter votre propre domaine :
1. **Cliquer sur** "Custom Domain"
2. **Entrer** votre domaine (ex: `api.archify.com`)
3. **Configurer les DNS** selon les instructions Railway

---

## üîí √âtape 9 : Configurer CORS

### A. Mettre √† Jour le Backend

**Fichier** : `backend/src/index.ts`

V√©rifier que CORS est configur√© pour accepter votre frontend Vercel :

```typescript
import cors from 'cors';

app.use(cors({
  origin: [
    'https://archify-project.vercel.app',  // Frontend Vercel
    'http://localhost:4200'  // Local development
  ],
  credentials: true
}));
```

### B. Utiliser la Variable d'Environnement

**Meilleure pratique** :

```typescript
const allowedOrigins = process.env.FRONTEND_URL?.split(',') || [
  'http://localhost:4200'
];

app.use(cors({
  origin: allowedOrigins,
  credentials: true
}));
```

Puis dans Railway Variables :
```
FRONTEND_URL=https://archify-project.vercel.app,http://localhost:4200
```

---

## üì° √âtape 10 : Mettre √† Jour le Frontend

### A. Cr√©er le Fichier d'Environnement de Production

**Fichier** : `frontend/src/environments/environment.prod.ts`

```typescript
export const environment = {
  production: true,
  apiUrl: 'https://archify-backend-production.up.railway.app/api'
};
```

### B. Mettre √† Jour les Services

**Exemple** : `frontend/src/app/services/auth.service.ts`

**Avant** :
```typescript
private readonly API_URL = 'http://localhost:3000/api';
```

**Apr√®s** :
```typescript
import { environment } from '../../environments/environment';

private readonly API_URL = environment.apiUrl;
```

**R√©p√©ter pour tous les services** :
- `auth.service.ts`
- `payment.service.ts`
- Etc.

### C. Mettre √† Jour angular.json

**Fichier** : `frontend/angular.json`

V√©rifier que la configuration de production utilise le bon fichier :

```json
{
  "projects": {
    "frontend": {
      "architect": {
        "build": {
          "configurations": {
            "production": {
              "fileReplacements": [
                {
                  "replace": "src/environments/environment.ts",
                  "with": "src/environments/environment.prod.ts"
                }
              ]
            }
          }
        }
      }
    }
  }
}
```

### D. Red√©ployer le Frontend sur Vercel

```bash
git add .
git commit -m "chore: Update API URL to Railway backend"
git push origin main
```

Vercel va automatiquement red√©ployer avec la nouvelle URL.

---

## ‚úÖ √âtape 11 : Tester le D√©ploiement

### A. Tester le Backend

#### Health Check
```bash
curl https://archify-backend-production.up.railway.app/healthz
```

**R√©sultat attendu** :
```json
{
  "status": "ok",
  "timestamp": "2025-10-16T..."
}
```

#### Test d'Authentification
```bash
curl -X POST https://archify-backend-production.up.railway.app/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "test123"
  }'
```

### B. Tester depuis le Frontend

1. **Aller sur** : https://archify-project.vercel.app
2. **Essayer de se connecter**
3. **V√©rifier les Network logs** (F12 ‚Üí Network)
4. **V√©rifier que les requ√™tes vont vers Railway**

---

## üêõ D√©pannage

### Erreur : `Database connection failed`

**Solution** :
1. V√©rifier que `DATABASE_URL` est bien configur√©e
2. V√©rifier que PostgreSQL est d√©marr√© sur Railway
3. V√©rifier les logs : Railway Dashboard ‚Üí Service ‚Üí Logs

---

### Erreur : `Prisma Client not generated`

**Solution** :
```bash
railway run npx prisma generate
```

Ou ajouter √† `package.json` :
```json
{
  "scripts": {
    "build": "prisma generate && tsc"
  }
}
```

---

### Erreur : `CORS policy`

**Solution** :
1. V√©rifier que `FRONTEND_URL` contient l'URL Vercel
2. V√©rifier la configuration CORS dans `backend/src/index.ts`
3. Red√©ployer le backend

---

### Erreur : `Port already in use`

**Solution** :
Railway g√®re automatiquement les ports. Utiliser :
```typescript
const PORT = process.env.PORT || 3000;
app.listen(PORT);
```

---

### Les Logs ne s'affichent pas

**Solution** :
1. **Dans Railway**, cliquer sur votre service
2. **Aller dans** "Deployments"
3. **Cliquer sur** le dernier d√©ploiement
4. **Voir les logs** en temps r√©el

---

## üìä Monitoring

### A. Logs Railway

**Railway Dashboard** ‚Üí **Service** ‚Üí **Deployments** ‚Üí **View Logs**

Les logs montrent :
- ‚úÖ D√©marrage du serveur
- ‚úÖ Connexion √† la base de donn√©es
- ‚úÖ Requ√™tes HTTP
- ‚ùå Erreurs et exceptions

### B. M√©triques

**Railway Dashboard** ‚Üí **Service** ‚Üí **Metrics**

Affiche :
- üìà CPU usage
- üíæ Memory usage
- üåê Network traffic
- ‚è±Ô∏è Response time

---

## üí∞ Co√ªts Railway

### Plan Gratuit (Trial)

- ‚úÖ $5 de cr√©dits gratuits par mois
- ‚úÖ Suffisant pour un petit projet
- ‚úÖ Pas de carte bancaire requise initialement

### Plan Hobby ($5/mois)

- ‚úÖ $5 de cr√©dits inclus
- ‚úÖ Id√©al pour des projets personnels
- ‚úÖ Support PostgreSQL

### Estimation Archify

**Backend + PostgreSQL** :
- Backend : ~$2-3/mois (usage l√©ger)
- PostgreSQL : ~$1-2/mois (petite DB)
- **Total** : ~$3-5/mois

---

## üîÑ D√©ploiement Automatique

### A. Configuration

Railway d√©ploie automatiquement √† chaque push sur GitHub :

1. **Commit et push** :
```bash
git add .
git commit -m "Update backend"
git push origin main
```

2. **Railway d√©tecte** le changement
3. **Rebuild automatique** du backend
4. **Red√©ploiement** en quelques minutes

### B. D√©sactiver le D√©ploiement Auto

**Railway Dashboard** ‚Üí **Service** ‚Üí **Settings** ‚Üí **Disable Auto Deploy**

---

## üìö Checklist Compl√®te

### Avant le D√©ploiement

- [x] Cr√©er `railway.json`
- [x] Cr√©er `Procfile`
- [x] V√©rifier `package.json` (scripts build et start)
- [x] V√©rifier que le backend fonctionne en local
- [ ] Cr√©er un compte Railway
- [ ] Connecter GitHub √† Railway

### D√©ploiement Backend

- [ ] Cr√©er un nouveau projet Railway
- [ ] Importer depuis GitHub (`Archify_Project`)
- [ ] Ajouter PostgreSQL
- [ ] Configurer les variables d'environnement
- [ ] G√©n√©rer un domaine public
- [ ] Ex√©cuter les migrations Prisma
- [ ] Tester l'endpoint `/healthz`

### Connexion Frontend ‚Üî Backend

- [ ] Cr√©er `environment.prod.ts`
- [ ] Mettre √† jour tous les services avec `environment.apiUrl`
- [ ] Configurer CORS dans le backend
- [ ] Commit et push les changements
- [ ] Vercel red√©ploie automatiquement
- [ ] Tester l'authentification depuis le frontend

### Tests Finaux

- [ ] Se connecter depuis le frontend Vercel
- [ ] Cr√©er un nouvel utilisateur
- [ ] Tester l'upload de fichiers
- [ ] Tester le paiement manuel
- [ ] V√©rifier les vid√©os prot√©g√©es

---

## üéØ R√©sum√©

### URLs Finales

- **Frontend Vercel** : `https://archify-project.vercel.app`
- **Backend Railway** : `https://archify-backend-production.up.railway.app`
- **Base de Donn√©es** : PostgreSQL h√©berg√©e sur Railway (priv√©e)

### Architecture D√©ploy√©e

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          GitHub Repository              ‚îÇ
‚îÇ       (Source de v√©rit√©)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ                    ‚îÇ
           ‚îÇ Auto-deploy        ‚îÇ Auto-deploy
           ‚ñº                    ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   Vercel   ‚îÇ       ‚îÇ  Railway   ‚îÇ
    ‚îÇ  Frontend  ‚îÇ‚óÑ‚îÄAPI‚îÄ‚îÄ‚îÇ  Backend   ‚îÇ
    ‚îÇ  (Static)  ‚îÇ       ‚îÇ  (Node.js) ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚îÇ Connect
                              ‚ñº
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ PostgreSQL ‚îÇ
                         ‚îÇ  Database  ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

**Version** : 1.0
**Date** : 16 octobre 2025
**Auteur** : Claude Code
**Statut** : Guide complet pr√™t √† l'emploi
